# AGENTS.md

## Project overview

This repository contains the **Ethereum Proof-of-Stake Consensus
Specifications**. It serves as:

- **Formal specifications** in human-readable markdown with embedded Python
- **Executable reference implementation** (Python code generated from markdown)
- **Reference test generator** for client implementations
- **Protocol development platform** organized by network upgrades (forks)

The specifications define how Ethereum's consensus layer (beacon chain)
operates.

## Directory structure

```
/specs/
  phase0/       # The genesis specs
  altair/       # The 1st upgrade (starts with A)
  bellatrix/    # The 2nd upgrade (starts with B)
  ...
  _features/    # Features which have not been scheduled for inclusion

/tests/
  core/pyspec/  # Generated Python specs and test suite
  generators/   # Reference test generators
  formats/      # Test format specifications

/pysetup/       # Spec generation pipeline (markdown â†’ Python)
/presets/       # Network parameters (mainnet and minimal)
/configs/       # Network configurations
/fork_choice/   # Fork choice protocol spec
/sync/          # Optimistic sync protocol
/ssz/           # SSZ serialization spec
```

## Key conventions

### Specification files

#### Structure

1. Title
2. Table of contents
3. Introduction
4. Types
5. Constants
6. Presets
7. Configuration
8. Containers
9. Functions

#### Warnings

Check the README to see which forks are stable vs in-development. In-development
specs must include a warning at the top:

```
*Note*: This document is a work-in-progress for researchers and implementers.
```

This line should be removed once the spec becomes stable.

#### Table of contents

The table of contents is auto-generated by `make lint` - don't update it
manually. New spec files need these TOC markers added manually:

```
<!-- mdformat-toc start --slug=github --no-anchors --maxlevel=6 --minlevel=2 -->
<!-- mdformat-toc end -->
```

### Markdown directives

Special HTML comments control spec parsing:

- `<!-- eth2spec: skip -->` - Skip the next code block (used for non-executable
  specs like `p2p-interface.md`)
- `<!-- predefined-type -->` - Type is defined externally
- `<!-- predefined -->` - Constant is predefined or function-dependent

### Python code in markdown

Python code is embedded in fenced code blocks and must be:

- Valid, executable Python
- Fully type-hinted
- Include docstrings for functions (wrapped at 80 chars, proper punctuation,
  double backticks for inline code)

Example:

```python
def get_active_validator_indices(state: BeaconState, epoch: Epoch) -> Sequence[ValidatorIndex]:
    """
    Return the sequence of active validator indices at ``epoch``.
    """
    return [
        ValidatorIndex(i) for i, v in enumerate(state.validators) if is_active_validator(v, epoch)
    ]
```

### Code style

The specs are implemented by many clients in different languages. Keep code
simple and readable:

- Avoid Python-specific features like `map`, `filter`, `lambda`, or complex
  comprehensions
- Prefer simple `for` loops over clever one-liners when it aids readability
- Use straightforward control flow that translates easily to other languages
- Be concise but not overly verbose
- Match the style of existing spec code

### Fork modification markers

Comments mark specific changes **within** functions or containers, not above the
entire definition.

**Example: function parameters:**

*Note*: The "# Removed `field`" pattern documents function parameters or class
fields that existed in a previous fork but were removed in this one.

```python
def process_execution_payload(
    state: BeaconState,
    # [Modified in Gloas:EIP7732]
    # Removed `body`
    # [New in Gloas:EIP7732]
    signed_envelope: SignedExecutionPayloadEnvelope,
    execution_engine: ExecutionEngine,
    # [New in Gloas:EIP7732]
    verify: bool = True,
) -> None:
    pass
```

**Example: modified container:**

```python
class DataColumnSidecar(Container):
    index: ColumnIndex
    column: List[Cell, MAX_BLOB_COMMITMENTS_PER_BLOCK]
    # [Modified in Gloas:EIP7732]
    # Removed `kzg_commitments`
    kzg_proofs: List[KZGProof, MAX_BLOB_COMMITMENTS_PER_BLOCK]
    # [Modified in Gloas:EIP7732]
    # Removed `signed_block_header`
    # [New in Gloas:EIP7732]
    slot: Slot
    # [New in Gloas:EIP7732]
    beacon_block_root: Root
```

**Example: new container with multiple EIPs:**

*Note*: If a change is associated with one or more EIPs, list all of them. Only
omit the EIP if the change is unrelated to any EIP (more common in older forks).

```python
class ExecutionRequests(Container):
    # [New in Electra:EIP6110]
    deposits: List[DepositRequest, MAX_DEPOSIT_REQUESTS_PER_PAYLOAD]
    # [New in Electra:EIP7002:EIP7251]
    withdrawals: List[WithdrawalRequest, MAX_WITHDRAWAL_REQUESTS_PER_PAYLOAD]
    # [New in Electra:EIP7251]
    consolidations: List[ConsolidationRequest, MAX_CONSOLIDATION_REQUESTS_PER_PAYLOAD]
```

### Container definitions

SSZ containers use Python dataclass-style syntax:

```python
class PendingConsolidation(Container):
    source_index: ValidatorIndex
    target_index: ValidatorIndex
```

### Type system

- **Custom types**: `Slot`, `Epoch`, `Gwei`, `Root`, `BLSPubkey`,
  `ValidatorIndex`, etc.
- **SSZ primitives**: `uint8`, `uint16`, `uint32`, `uint64`, `uint256`,
  `boolean`, `Bytes32`
- **SSZ composites**: `Container`, `List[T, N]`, `Vector[T, N]`, `Bitlist[N]`,
  `Bitvector[N]`

### Presets vs configs

**Presets** (compile-time) define protocol limits that affect type sizes:

- Located in `presets/mainnet/` and `presets/minimal/`
- Examples: `MAX_VALIDATORS_PER_COMMITTEE`, `SLOTS_PER_EPOCH`
- Changing these requires recompiling

**Configs** (runtime) define network-specific parameters:

- Located in `configs/`
- Examples: `GENESIS_FORK_VERSION`, `ELECTRA_FORK_EPOCH`,
  `DEPOSIT_CONTRACT_ADDRESS`
- Can be changed without recompilation

When adding new constants, determine if they affect type sizes (preset) or are
just network parameters (config). Preset values go in both `mainnet/` and
`minimal/` directories.

**Important**: Do not create presets or configs that are derived from other
presets or configs. Each value should be defined independently.

## Build commands

Everything is done through the Makefile. Run `make help verbose=true` for full
documentation.

```bash
# Run all minimal preset tests (fast)
make test

# Run all mainnet preset tests (slow)
make test preset=mainnet

# Run tests for a specific fork
make test fork=deneb

# Run tests matching a pattern (partial match)
make test k=deposit  # Runs all tests with "deposit" in the name

# Combine options
make test preset=mainnet fork=deneb k=test_verify_kzg_proof

# Run linters, formatters, and checks
make lint
```

## Writing tests

### Reference tests vs unittests

**Reference tests** generate test vectors that client implementations use.
Prefer reference tests when possible since they benefit the entire ecosystem.

**Unittests** are internal-only tests that don't produce reference files. Use
these when reference tests aren't feasible (e.g., testing internal helpers or
edge cases that don't map to client behavior).

### Test decorators

When writing tests, use these decorators:

- `@with_all_phases` - Run on all forks
- `@with_phases([DENEB, FULU])` - Run on specific forks
- `@with_deneb_and_later` - Run on Deneb and all subsequent forks
- `@with_electra_and_later` - Run on Electra and all subsequent forks
- `@spec_state_test` - State transition test
- `@spec_test` - General spec test
- `@always_bls` - Always enable BLS verification

### Test pattern

Tests yield their outputs for reference test generation:

```python
@with_all_phases
@spec_state_test
def test_example(spec, state):
    # Setup
    yield "pre", state

    # Execute
    block = build_empty_block_for_next_slot(spec, state)
    signed_block = state_transition_and_sign_block(spec, state, block)

    yield "blocks", [signed_block]
    yield "post", state
```

## Common tasks

### Adding a new helper function

1. Add the Python function to the appropriate spec markdown file
2. Add tests in `tests/core/pyspec/eth2spec/test/`
3. Run `make lint` to run checks
4. Run `make test k=your_test_name` (this regenerates specs automatically)

### Modifying an existing function

1. Find the function in the spec markdown
2. Make your changes, adding fork modification comments above changed lines
3. Run `make lint` to run checks
4. Run `make test` (this regenerates specs automatically)

### Adding a new container field

1. Add field to container definition in spec markdown
2. Update any functions that construct or use the container
3. Update preset/config if needed
4. Run `make lint` then `make test`

### Adding a new fork or feature

Adding a new fork (e.g., "foobar") requires updates to many files:

**1. Build system:**

- `Makefile` - Add to `ALL_EXECUTABLE_SPEC_NAMES`

**2. GitHub automation:**

- `.github/labeler.yml` - Add label config for auto-labeling PRs
- `.github/release-drafter.yml` - Add category for release notes

**3. Spec generation (`pysetup/`):**

- `pysetup/constants.py` - Add `FOOBAR = "foobar"`
- `pysetup/md_doc_paths.py` - Import constant, add to `PREVIOUS_FORK_OF`
- `pysetup/spec_builders/foobar.py` - Create SpecBuilder class
- `pysetup/spec_builders/__init__.py` - Import and register the SpecBuilder

**4. Test infrastructure (`tests/core/pyspec/eth2spec/test/`):**

- `helpers/constants.py` - Add constant, update `ALL_PHASES`,
  `PREVIOUS_FORK_OF`, `POST_FORK_OF`
- `helpers/forks.py` - Add `is_post_foobar(spec)` function
- `context.py` - Add `with_foobar_and_later` decorator

**5. Spec files:**

- `specs/foobar/` - For scheduled forks
- `specs/_features/eipNNNN/` - For experimental features (must start with "eip")

**6. Presets (if the fork has preset values):**

- `presets/mainnet/foobar.yaml`
- `presets/minimal/foobar.yaml`

## Important notes

### Verify current spec behavior

This is an evolving specification. Do not rely on prior knowledge or cached
context when modifying the spec. Always read the current spec files to verify
how functions, containers, and logic actually behave before making changes.

### Do not edit generated files

Files in `tests/core/pyspec/eth2spec/{fork}/{preset}/` are **generated**. Edit
the source markdown in `/specs/` instead.

### Fork inheritance

Each fork inherits all specs from the previous fork. The chain is defined in
`pysetup/md_doc_paths.py` via `PREVIOUS_FORK_OF`. When generating a fork's spec,
all markdown files from ancestor forks are loaded first.

When adding to a new fork:

- Reference the previous fork at the top of the spec
- Only include new or modified sections
- Include an `upgrade_to_<fork>` function that converts the previous fork's
  `BeaconState` to the new fork's state

### Linting requirements

Run `make lint` before committing.

### Test organization

Tests mirror the spec structure:

```
tests/core/pyspec/eth2spec/test/
  {fork}/
    block_processing/
    epoch_processing/
    sanity/
    fork_choice/
    ...
```
