
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://ethereum.github.io/consensus-specs/specs/phase0/fork-choice/">
      
      
        <link rel="prev" href="../deposit-contract/">
      
      
        <link rel="next" href="../p2p-interface/">
      
      
      <link rel="icon" href="../../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.20">
    
    
      
        <title>Fork Choice - Ethereum Consensus Specs</title>
      
    
    
      <link rel="stylesheet" href="../../../assets/stylesheets/main.e53b48f4.min.css">
      
        
        <link rel="stylesheet" href="../../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../../stylesheets/extra.css">
    
    <script>__md_scope=new URL("../../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#phase-0-beacon-chain-fork-choice" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../.." title="Ethereum Consensus Specs" class="md-header__button md-logo" aria-label="Ethereum Consensus Specs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ethereum Consensus Specs
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Fork Choice
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="indigo"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../.." class="md-tabs__link">
          
  
  
  Home

        </a>
      </li>
    
  

      
        
  
  
  
    
  
  
    
    
      
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="../beacon-chain/" class="md-tabs__link">
          
  
  
  Specs

        </a>
      </li>
    
  

    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../docs/new-feature/" class="md-tabs__link">
          
  
  
  Docs

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../fork_choice/safe-block/" class="md-tabs__link">
          
  
  
  Fork choice

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../light-client/" class="md-tabs__link">
          
  
  
  Light client

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../ssz/merkle-proofs/" class="md-tabs__link">
          
  
  
  Ssz

        </a>
      </li>
    
  

      
        
  
  
  
  
    
    
      <li class="md-tabs__item">
        <a href="../../../sync/optimistic/" class="md-tabs__link">
          
  
  
  Sync

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../.." title="Ethereum Consensus Specs" class="md-nav__button md-logo" aria-label="Ethereum Consensus Specs" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Ethereum Consensus Specs
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_1" >
        
          
          <label class="md-nav__link" for="__nav_1" id="__nav_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_1">
            <span class="md-nav__icon md-icon"></span>
            Home
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Ethereum Proof-of-Stake Consensus Specifications
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Specs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Specs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_1" checked>
        
          
          <label class="md-nav__link" for="__nav_2_1" id="__nav_2_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Phase0
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_1_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2_1">
            <span class="md-nav__icon md-icon"></span>
            Phase0
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../deposit-contract/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deposit Contract
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fork-choice" class="md-nav__link">
    <span class="md-ellipsis">
      Fork choice
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fork choice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constant" class="md-nav__link">
    <span class="md-ellipsis">
      Constant
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#time-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Time parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helpers" class="md-nav__link">
    <span class="md-ellipsis">
      Helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#latestmessage" class="md-nav__link">
    <span class="md-ellipsis">
      LatestMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#store" class="md-nav__link">
    <span class="md-ellipsis">
      Store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_forkchoice_store" class="md-nav__link">
    <span class="md-ellipsis">
      get_forkchoice_store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_slots_since_genesis" class="md-nav__link">
    <span class="md-ellipsis">
      get_slots_since_genesis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_current_slot" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_slot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_current_store_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_store_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute_slots_since_epoch_start" class="md-nav__link">
    <span class="md-ellipsis">
      compute_slots_since_epoch_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_ancestor" class="md-nav__link">
    <span class="md-ellipsis">
      get_ancestor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calculate_committee_fraction" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_committee_fraction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_checkpoint_block" class="md-nav__link">
    <span class="md-ellipsis">
      get_checkpoint_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_proposer_score" class="md-nav__link">
    <span class="md-ellipsis">
      get_proposer_score
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_weight" class="md-nav__link">
    <span class="md-ellipsis">
      get_weight
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_voting_source" class="md-nav__link">
    <span class="md-ellipsis">
      get_voting_source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter_block_tree" class="md-nav__link">
    <span class="md-ellipsis">
      filter_block_tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_filtered_block_tree" class="md-nav__link">
    <span class="md-ellipsis">
      get_filtered_block_tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_head" class="md-nav__link">
    <span class="md-ellipsis">
      get_head
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_checkpoints" class="md-nav__link">
    <span class="md-ellipsis">
      update_checkpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_unrealized_checkpoints" class="md-nav__link">
    <span class="md-ellipsis">
      update_unrealized_checkpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seconds_to_milliseconds" class="md-nav__link">
    <span class="md-ellipsis">
      seconds_to_milliseconds
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_slot_component_duration_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_slot_component_duration_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_attestation_due_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_attestation_due_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_proposer_reorg_cutoff_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_proposer_reorg_cutoff_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_aggregate_due_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_aggregate_due_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proposer-head-and-reorg-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      Proposer head and reorg helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposer head and reorg helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#is_head_late" class="md-nav__link">
    <span class="md-ellipsis">
      is_head_late
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_shuffling_stable" class="md-nav__link">
    <span class="md-ellipsis">
      is_shuffling_stable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_ffg_competitive" class="md-nav__link">
    <span class="md-ellipsis">
      is_ffg_competitive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_finalization_ok" class="md-nav__link">
    <span class="md-ellipsis">
      is_finalization_ok
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_proposing_on_time" class="md-nav__link">
    <span class="md-ellipsis">
      is_proposing_on_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_head_weak" class="md-nav__link">
    <span class="md-ellipsis">
      is_head_weak
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_parent_strong" class="md-nav__link">
    <span class="md-ellipsis">
      is_parent_strong
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_proposer_head" class="md-nav__link">
    <span class="md-ellipsis">
      get_proposer_head
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pull-up-tip-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      Pull-up tip helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pull-up tip helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compute_pulled_up_tip" class="md-nav__link">
    <span class="md-ellipsis">
      compute_pulled_up_tip
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_tick-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      on_tick helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="on_tick helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on_tick_per_slot" class="md-nav__link">
    <span class="md-ellipsis">
      on_tick_per_slot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_attestation-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      on_attestation helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="on_attestation helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validate_target_epoch_against_current_time" class="md-nav__link">
    <span class="md-ellipsis">
      validate_target_epoch_against_current_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate_on_attestation" class="md-nav__link">
    <span class="md-ellipsis">
      validate_on_attestation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#store_target_checkpoint_state" class="md-nav__link">
    <span class="md-ellipsis">
      store_target_checkpoint_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_latest_messages" class="md-nav__link">
    <span class="md-ellipsis">
      update_latest_messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Handlers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Handlers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on_tick" class="md-nav__link">
    <span class="md-ellipsis">
      on_tick
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_block" class="md-nav__link">
    <span class="md-ellipsis">
      on_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_attestation" class="md-nav__link">
    <span class="md-ellipsis">
      on_attestation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_attester_slashing" class="md-nav__link">
    <span class="md-ellipsis">
      on_attester_slashing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../weak-subjectivity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Weak Subjectivity
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2" >
        
          
          <label class="md-nav__link" for="__nav_2_2" id="__nav_2_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Altair
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2">
            <span class="md-nav__icon md-icon"></span>
            Altair
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/bls/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    BLS
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_2_7" id="__nav_2_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Light Client
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_2_7">
            <span class="md-nav__icon md-icon"></span>
            Light Client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/light-client/full-node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Full Node
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/light-client/light-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Light Client
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/light-client/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/light-client/sync-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sync Protocol
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_3" >
        
          
          <label class="md-nav__link" for="__nav_2_3" id="__nav_2_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Bellatrix
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_3">
            <span class="md-nav__icon md-icon"></span>
            Bellatrix
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bellatrix/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bellatrix/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bellatrix/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bellatrix/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bellatrix/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4" >
        
          
          <label class="md-nav__link" for="__nav_2_4" id="__nav_2_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Capella
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4">
            <span class="md-nav__icon md-icon"></span>
            Capella
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_4_6" >
        
          
          <label class="md-nav__link" for="__nav_2_4_6" id="__nav_2_4_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Light Client
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_4_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_4_6">
            <span class="md-nav__icon md-icon"></span>
            Light Client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/light-client/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/light-client/full-node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Full Node
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/light-client/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/light-client/sync-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sync Protocol
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5" >
        
          
          <label class="md-nav__link" for="__nav_2_5" id="__nav_2_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Deneb
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5">
            <span class="md-nav__icon md-icon"></span>
            Deneb
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/polynomial-commitments/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Polynomial Commitments
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_5_7" >
        
          
          <label class="md-nav__link" for="__nav_2_5_7" id="__nav_2_5_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Light Client
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_5_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_5_7">
            <span class="md-nav__icon md-icon"></span>
            Light Client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/light-client/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/light-client/full-node/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Full Node
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/light-client/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/light-client/sync-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sync Protocol
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6" id="__nav_2_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Electra
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6">
            <span class="md-nav__icon md-icon"></span>
            Electra
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/weak-subjectivity/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Weak Subjectivity
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_6_6" >
        
          
          <label class="md-nav__link" for="__nav_2_6_6" id="__nav_2_6_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Light Client
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_6_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_6_6">
            <span class="md-nav__icon md-icon"></span>
            Light Client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/light-client/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/light-client/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../electra/light-client/sync-protocol/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Sync Protocol
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_7" >
        
          
          <label class="md-nav__link" for="__nav_2_7" id="__nav_2_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fulu
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_7">
            <span class="md-nav__icon md-icon"></span>
            Fulu
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/das-core/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    DAS Core
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/polynomial-commitments-sampling/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Polynomial Commitments Sampling
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../fulu/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_8" >
        
          
          <label class="md-nav__link" for="__nav_2_8" id="__nav_2_8_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Gloas
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_8_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_8">
            <span class="md-nav__icon md-icon"></span>
            Gloas
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gloas/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gloas/builder/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Builder
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gloas/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gloas/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gloas/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../gloas/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9" >
        
          
          <label class="md-nav__link" for="__nav_2_9" id="__nav_2_9_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Features
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_2_9_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9">
            <span class="md-nav__icon md-icon"></span>
            Features
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_1" >
        
          
          <label class="md-nav__link" for="__nav_2_9_1" id="__nav_2_9_1_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Eip6800
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_1">
            <span class="md-nav__icon md-icon"></span>
            Eip6800
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip6800/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip6800/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip6800/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_2" >
        
          
          <label class="md-nav__link" for="__nav_2_9_2" id="__nav_2_9_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Eip6914
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_2">
            <span class="md-nav__icon md-icon"></span>
            Eip6914
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip6914/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip6914/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_3" >
        
          
          <label class="md-nav__link" for="__nav_2_9_3" id="__nav_2_9_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Eip7441
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_3">
            <span class="md-nav__icon md-icon"></span>
            Eip7441
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7441/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7441/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_4" >
        
          
          <label class="md-nav__link" for="__nav_2_9_4" id="__nav_2_9_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Eip7805
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_4">
            <span class="md-nav__icon md-icon"></span>
            Eip7805
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7805/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7805/fork-choice/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7805/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7805/inclusion-list/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Inclusion List
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7805/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7805/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_5" >
        
          
          <label class="md-nav__link" for="__nav_2_9_5" id="__nav_2_9_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Eip7928
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_5">
            <span class="md-nav__icon md-icon"></span>
            Eip7928
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7928/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7928/fork/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip7928/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2_9_6" >
        
          
          <label class="md-nav__link" for="__nav_2_9_6" id="__nav_2_9_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Eip8025
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_2_9_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_2_9_6">
            <span class="md-nav__icon md-icon"></span>
            Eip8025
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip8025/beacon-chain/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Beacon Chain
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip8025/p2p-interface/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    P2P Interface
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip8025/validator/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Validator
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../_features/eip8025/zkevm/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Zkevm
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Docs
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Docs
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/new-feature/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    How to add a new feature proposal in consensus-specs
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../docs/release/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Release Procedure
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fork choice
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Fork choice
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../fork_choice/safe-block/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Fork Choice -- Safe Block
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4_2" >
        
          
          <label class="md-nav__link" for="__nav_4_2" id="__nav_4_2_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Fork Choice -- Core
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4_2">
            <span class="md-nav__icon md-icon"></span>
            Fork Choice -- Core
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    phase0
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../bellatrix/fork-choice" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    bellatrix
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/fork-choice" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    capella
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/fork-choice" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    deneb
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Light client
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Light client
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../light-client/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Index
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../altair/light-client/sync-protocol" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Altair
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../capella/light-client/sync-protocol" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Capella
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../deneb/light-client/sync-protocol" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Deneb
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_6" >
        
          
          <label class="md-nav__link" for="__nav_6" id="__nav_6_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Ssz
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_6">
            <span class="md-nav__icon md-icon"></span>
            Ssz
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ssz/merkle-proofs/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Merkle proof formats
    
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../ssz/simple-serialize/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    SimpleSerialize (SSZ)
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
    
      
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_7" >
        
          
          <label class="md-nav__link" for="__nav_7" id="__nav_7_label" tabindex="0">
            
  
  
  <span class="md-ellipsis">
    Sync
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_7_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_7">
            <span class="md-nav__icon md-icon"></span>
            Sync
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../../sync/optimistic/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Optimistic Sync
    
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#introduction" class="md-nav__link">
    <span class="md-ellipsis">
      Introduction
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#fork-choice" class="md-nav__link">
    <span class="md-ellipsis">
      Fork choice
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Fork choice">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#constant" class="md-nav__link">
    <span class="md-ellipsis">
      Constant
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#time-parameters" class="md-nav__link">
    <span class="md-ellipsis">
      Time parameters
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#helpers" class="md-nav__link">
    <span class="md-ellipsis">
      Helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#latestmessage" class="md-nav__link">
    <span class="md-ellipsis">
      LatestMessage
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#store" class="md-nav__link">
    <span class="md-ellipsis">
      Store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_forkchoice_store" class="md-nav__link">
    <span class="md-ellipsis">
      get_forkchoice_store
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_slots_since_genesis" class="md-nav__link">
    <span class="md-ellipsis">
      get_slots_since_genesis
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_current_slot" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_slot
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_current_store_epoch" class="md-nav__link">
    <span class="md-ellipsis">
      get_current_store_epoch
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compute_slots_since_epoch_start" class="md-nav__link">
    <span class="md-ellipsis">
      compute_slots_since_epoch_start
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_ancestor" class="md-nav__link">
    <span class="md-ellipsis">
      get_ancestor
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#calculate_committee_fraction" class="md-nav__link">
    <span class="md-ellipsis">
      calculate_committee_fraction
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_checkpoint_block" class="md-nav__link">
    <span class="md-ellipsis">
      get_checkpoint_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_proposer_score" class="md-nav__link">
    <span class="md-ellipsis">
      get_proposer_score
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_weight" class="md-nav__link">
    <span class="md-ellipsis">
      get_weight
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_voting_source" class="md-nav__link">
    <span class="md-ellipsis">
      get_voting_source
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#filter_block_tree" class="md-nav__link">
    <span class="md-ellipsis">
      filter_block_tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_filtered_block_tree" class="md-nav__link">
    <span class="md-ellipsis">
      get_filtered_block_tree
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_head" class="md-nav__link">
    <span class="md-ellipsis">
      get_head
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_checkpoints" class="md-nav__link">
    <span class="md-ellipsis">
      update_checkpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_unrealized_checkpoints" class="md-nav__link">
    <span class="md-ellipsis">
      update_unrealized_checkpoints
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#seconds_to_milliseconds" class="md-nav__link">
    <span class="md-ellipsis">
      seconds_to_milliseconds
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_slot_component_duration_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_slot_component_duration_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_attestation_due_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_attestation_due_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_proposer_reorg_cutoff_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_proposer_reorg_cutoff_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_aggregate_due_ms" class="md-nav__link">
    <span class="md-ellipsis">
      get_aggregate_due_ms
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#proposer-head-and-reorg-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      Proposer head and reorg helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Proposer head and reorg helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#is_head_late" class="md-nav__link">
    <span class="md-ellipsis">
      is_head_late
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_shuffling_stable" class="md-nav__link">
    <span class="md-ellipsis">
      is_shuffling_stable
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_ffg_competitive" class="md-nav__link">
    <span class="md-ellipsis">
      is_ffg_competitive
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_finalization_ok" class="md-nav__link">
    <span class="md-ellipsis">
      is_finalization_ok
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_proposing_on_time" class="md-nav__link">
    <span class="md-ellipsis">
      is_proposing_on_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_head_weak" class="md-nav__link">
    <span class="md-ellipsis">
      is_head_weak
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#is_parent_strong" class="md-nav__link">
    <span class="md-ellipsis">
      is_parent_strong
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#get_proposer_head" class="md-nav__link">
    <span class="md-ellipsis">
      get_proposer_head
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#pull-up-tip-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      Pull-up tip helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Pull-up tip helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#compute_pulled_up_tip" class="md-nav__link">
    <span class="md-ellipsis">
      compute_pulled_up_tip
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_tick-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      on_tick helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="on_tick helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on_tick_per_slot" class="md-nav__link">
    <span class="md-ellipsis">
      on_tick_per_slot
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_attestation-helpers" class="md-nav__link">
    <span class="md-ellipsis">
      on_attestation helpers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="on_attestation helpers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#validate_target_epoch_against_current_time" class="md-nav__link">
    <span class="md-ellipsis">
      validate_target_epoch_against_current_time
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#validate_on_attestation" class="md-nav__link">
    <span class="md-ellipsis">
      validate_on_attestation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#store_target_checkpoint_state" class="md-nav__link">
    <span class="md-ellipsis">
      store_target_checkpoint_state
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#update_latest_messages" class="md-nav__link">
    <span class="md-ellipsis">
      update_latest_messages
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#handlers" class="md-nav__link">
    <span class="md-ellipsis">
      Handlers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Handlers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#on_tick" class="md-nav__link">
    <span class="md-ellipsis">
      on_tick
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_block" class="md-nav__link">
    <span class="md-ellipsis">
      on_block
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_attestation" class="md-nav__link">
    <span class="md-ellipsis">
      on_attestation
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#on_attester_slashing" class="md-nav__link">
    <span class="md-ellipsis">
      on_attester_slashing
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="phase-0-beacon-chain-fork-choice">Phase 0 -- Beacon Chain Fork Choice<a class="headerlink" href="#phase-0-beacon-chain-fork-choice" title="Permanent link">&para;</a></h1>
<!-- mdformat-toc start --slug=github --no-anchors --maxlevel=6 --minlevel=2 -->

<ul>
<li><a href="#introduction">Introduction</a></li>
<li><a href="#fork-choice">Fork choice</a></li>
<li><a href="#constant">Constant</a></li>
<li><a href="#configuration">Configuration</a><ul>
<li><a href="#time-parameters">Time parameters</a></li>
</ul>
</li>
<li><a href="#helpers">Helpers</a><ul>
<li><a href="#latestmessage"><code>LatestMessage</code></a></li>
<li><a href="#store"><code>Store</code></a></li>
<li><a href="#get_forkchoice_store"><code>get_forkchoice_store</code></a></li>
<li><a href="#get_slots_since_genesis"><code>get_slots_since_genesis</code></a></li>
<li><a href="#get_current_slot"><code>get_current_slot</code></a></li>
<li><a href="#get_current_store_epoch"><code>get_current_store_epoch</code></a></li>
<li><a href="#compute_slots_since_epoch_start"><code>compute_slots_since_epoch_start</code></a></li>
<li><a href="#get_ancestor"><code>get_ancestor</code></a></li>
<li><a href="#calculate_committee_fraction"><code>calculate_committee_fraction</code></a></li>
<li><a href="#get_checkpoint_block"><code>get_checkpoint_block</code></a></li>
<li><a href="#get_proposer_score"><code>get_proposer_score</code></a></li>
<li><a href="#get_weight"><code>get_weight</code></a></li>
<li><a href="#get_voting_source"><code>get_voting_source</code></a></li>
<li><a href="#filter_block_tree"><code>filter_block_tree</code></a></li>
<li><a href="#get_filtered_block_tree"><code>get_filtered_block_tree</code></a></li>
<li><a href="#get_head"><code>get_head</code></a></li>
<li><a href="#update_checkpoints"><code>update_checkpoints</code></a></li>
<li><a href="#update_unrealized_checkpoints"><code>update_unrealized_checkpoints</code></a></li>
<li><a href="#seconds_to_milliseconds"><code>seconds_to_milliseconds</code></a></li>
<li><a href="#get_slot_component_duration_ms"><code>get_slot_component_duration_ms</code></a></li>
<li><a href="#get_attestation_due_ms"><code>get_attestation_due_ms</code></a></li>
<li><a href="#get_proposer_reorg_cutoff_ms"><code>get_proposer_reorg_cutoff_ms</code></a></li>
<li><a href="#get_aggregate_due_ms"><code>get_aggregate_due_ms</code></a></li>
<li><a href="#proposer-head-and-reorg-helpers">Proposer head and reorg helpers</a></li>
<li><a href="#is_head_late"><code>is_head_late</code></a></li>
<li><a href="#is_shuffling_stable"><code>is_shuffling_stable</code></a></li>
<li><a href="#is_ffg_competitive"><code>is_ffg_competitive</code></a></li>
<li><a href="#is_finalization_ok"><code>is_finalization_ok</code></a></li>
<li><a href="#is_proposing_on_time"><code>is_proposing_on_time</code></a></li>
<li><a href="#is_head_weak"><code>is_head_weak</code></a></li>
<li><a href="#is_parent_strong"><code>is_parent_strong</code></a></li>
<li><a href="#get_proposer_head"><code>get_proposer_head</code></a></li>
<li><a href="#pull-up-tip-helpers">Pull-up tip helpers</a></li>
<li><a href="#compute_pulled_up_tip"><code>compute_pulled_up_tip</code></a></li>
<li><a href="#on_tick-helpers"><code>on_tick</code> helpers</a></li>
<li><a href="#on_tick_per_slot"><code>on_tick_per_slot</code></a></li>
<li><a href="#on_attestation-helpers"><code>on_attestation</code> helpers</a></li>
<li><a href="#validate_target_epoch_against_current_time"><code>validate_target_epoch_against_current_time</code></a></li>
<li><a href="#validate_on_attestation"><code>validate_on_attestation</code></a></li>
<li><a href="#store_target_checkpoint_state"><code>store_target_checkpoint_state</code></a></li>
<li><a href="#update_latest_messages"><code>update_latest_messages</code></a></li>
</ul>
</li>
<li><a href="#handlers">Handlers</a><ul>
<li><a href="#on_tick"><code>on_tick</code></a></li>
<li><a href="#on_block"><code>on_block</code></a></li>
<li><a href="#on_attestation"><code>on_attestation</code></a></li>
<li><a href="#on_attester_slashing"><code>on_attester_slashing</code></a></li>
</ul>
</li>
</ul>
<!-- mdformat-toc end -->

<h2 id="introduction">Introduction<a class="headerlink" href="#introduction" title="Permanent link">&para;</a></h2>
<p>This document is the beacon chain fork choice spec, part of Phase 0. It assumes
the <a href="../beacon-chain/">beacon chain state transition function spec</a>.</p>
<h2 id="fork-choice">Fork choice<a class="headerlink" href="#fork-choice" title="Permanent link">&para;</a></h2>
<p>The head block root associated with a <code>store</code> is defined as <code>get_head(store)</code>.
At genesis, let <code>store = get_forkchoice_store(genesis_state, genesis_block)</code> and
update <code>store</code> by running:</p>
<ul>
<li><code>on_tick(store, time)</code> whenever <code>time &gt; store.time</code> where <code>time</code> is the
  current Unix time</li>
<li><code>on_block(store, block)</code> whenever a block <code>block: SignedBeaconBlock</code> is
  received</li>
<li><code>on_attestation(store, attestation)</code> whenever an attestation <code>attestation</code> is
  received</li>
<li><code>on_attester_slashing(store, attester_slashing)</code> whenever an attester slashing
  <code>attester_slashing</code> is received</li>
</ul>
<p>Any of the above handlers that trigger an unhandled exception (e.g. a failed
assert or an out-of-range list access) are considered invalid. Invalid calls to
handlers must not modify <code>store</code>.</p>
<p><em>Notes</em>:</p>
<ol>
<li><strong>Leap seconds</strong>: Slots will last <code>SECONDS_PER_SLOT + 1</code> or
   <code>SECONDS_PER_SLOT - 1</code> seconds around leap seconds. This is automatically
   handled by <a href="https://en.wikipedia.org/wiki/Unix_time">UNIX time</a>.</li>
<li><strong>Honest clocks</strong>: Honest nodes are assumed to have clocks synchronized
   within <code>SECONDS_PER_SLOT</code> seconds of each other.</li>
<li><strong>Eth1 data</strong>: The large <code>ETH1_FOLLOW_DISTANCE</code> specified in the
   <a href="../validator/">honest validator document</a> should ensure that
   <code>state.latest_eth1_data</code> of the canonical beacon chain remains consistent
   with the canonical Ethereum proof-of-work chain. If not, emergency manual
   intervention will be required.</li>
<li><strong>Manual forks</strong>: Manual forks may arbitrarily change the fork choice rule
   but are expected to be enacted at epoch transitions, with the fork details
   reflected in <code>state.fork</code>.</li>
<li><strong>Implementation</strong>: The implementation found in this specification is
   constructed for ease of understanding rather than for optimization in
   computation, space, or any other resource. A number of optimized alternatives
   can be found <a href="https://github.com/protolambda/lmd-ghost">here</a>.</li>
</ol>
<h3 id="constant">Constant<a class="headerlink" href="#constant" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>INTERVALS_PER_SLOT</code> <em>deprecated</em></td>
<td><code>uint64(3)</code></td>
</tr>
<tr>
<td><code>BASIS_POINTS</code></td>
<td><code>uint64(10000)</code></td>
</tr>
</tbody>
</table>
<h3 id="configuration">Configuration<a class="headerlink" href="#configuration" title="Permanent link">&para;</a></h3>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PROPOSER_SCORE_BOOST</code></td>
<td><code>uint64(40)</code></td>
</tr>
<tr>
<td><code>REORG_HEAD_WEIGHT_THRESHOLD</code></td>
<td><code>uint64(20)</code></td>
</tr>
<tr>
<td><code>REORG_PARENT_WEIGHT_THRESHOLD</code></td>
<td><code>uint64(160)</code></td>
</tr>
<tr>
<td><code>REORG_MAX_EPOCHS_SINCE_FINALIZATION</code></td>
<td><code>Epoch(2)</code></td>
</tr>
</tbody>
</table>
<ul>
<li>The proposer score boost and re-org weight threshold are percentage values
  that are measured with respect to the weight of a single committee. See
  <code>calculate_committee_fraction</code>.</li>
</ul>
<h4 id="time-parameters">Time parameters<a class="headerlink" href="#time-parameters" title="Permanent link">&para;</a></h4>
<table>
<thead>
<tr>
<th>Name</th>
<th>Value</th>
<th style="text-align: center;">Unit</th>
<th style="text-align: center;">Duration</th>
</tr>
</thead>
<tbody>
<tr>
<td><code>PROPOSER_REORG_CUTOFF_BPS</code></td>
<td><code>uint64(1667)</code></td>
<td style="text-align: center;">basis points</td>
<td style="text-align: center;">~17% of <code>SLOT_DURATION_MS</code></td>
</tr>
</tbody>
</table>
<h3 id="helpers">Helpers<a class="headerlink" href="#helpers" title="Permanent link">&para;</a></h3>
<h4 id="latestmessage"><code>LatestMessage</code><a class="headerlink" href="#latestmessage" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-0-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-0-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-0-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-0-4">4</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a><span style="color: #A6E22E">@dataclass</span><span style="color: #F8F8F2">(eq</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">,</span> <span style="color: #F8F8F2">frozen</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span>
<a id="__codelineno-0-2" name="__codelineno-0-2"></a><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">LatestMessage</span><span style="color: #F8F8F2">(object):</span>
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>    <span style="color: #F8F8F2">epoch:</span> <span style="color: #F8F8F2">Epoch</span>
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>    <span style="color: #F8F8F2">root:</span> <span style="color: #F8F8F2">Root</span>
</code></pre></div></td></tr></table></div>
<h4 id="store"><code>Store</code><a class="headerlink" href="#store" title="Permanent link">&para;</a></h4>
<p>The <code>Store</code> is responsible for tracking information required for the fork choice
algorithm. The important fields being tracked are described below:</p>
<ul>
<li><code>justified_checkpoint</code>: the justified checkpoint used as the starting point
  for the LMD GHOST fork choice algorithm.</li>
<li><code>finalized_checkpoint</code>: the highest known finalized checkpoint. The fork
  choice only considers blocks that are not conflicting with this checkpoint.</li>
<li><code>unrealized_justified_checkpoint</code> &amp; <code>unrealized_finalized_checkpoint</code>: these
  track the highest justified &amp; finalized checkpoints resp., without regard to
  whether on-chain <strong><em>realization</em></strong> has occurred, i.e. FFG processing of new
  attestations within the state transition function. This is an important
  distinction from <code>justified_checkpoint</code> &amp; <code>finalized_checkpoint</code>, because they
  will only track the checkpoints that are realized on-chain. Note that on-chain
  processing of FFG information only happens at epoch boundaries.</li>
<li><code>unrealized_justifications</code>: stores a map of block root to the unrealized
  justified checkpoint observed in that block.</li>
</ul>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-1-16">16</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a><span style="color: #A6E22E">@dataclass</span>
<a id="__codelineno-1-2" name="__codelineno-1-2"></a><span style="color: #66D9EF">class</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">Store</span><span style="color: #F8F8F2">(object):</span>
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>    <span style="color: #F8F8F2">time:</span> <span style="color: #F8F8F2">uint64</span>
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>    <span style="color: #F8F8F2">genesis_time:</span> <span style="color: #F8F8F2">uint64</span>
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>    <span style="color: #F8F8F2">justified_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint</span>
<a id="__codelineno-1-6" name="__codelineno-1-6"></a>    <span style="color: #F8F8F2">finalized_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint</span>
<a id="__codelineno-1-7" name="__codelineno-1-7"></a>    <span style="color: #F8F8F2">unrealized_justified_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint</span>
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>    <span style="color: #F8F8F2">unrealized_finalized_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint</span>
<a id="__codelineno-1-9" name="__codelineno-1-9"></a>    <span style="color: #F8F8F2">proposer_boost_root:</span> <span style="color: #F8F8F2">Root</span>
<a id="__codelineno-1-10" name="__codelineno-1-10"></a>    <span style="color: #F8F8F2">equivocating_indices:</span> <span style="color: #F8F8F2">Set[ValidatorIndex]</span>
<a id="__codelineno-1-11" name="__codelineno-1-11"></a>    <span style="color: #F8F8F2">blocks:</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">BeaconBlock]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">field(default_factory</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">dict)</span>
<a id="__codelineno-1-12" name="__codelineno-1-12"></a>    <span style="color: #F8F8F2">block_states:</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">BeaconState]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">field(default_factory</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">dict)</span>
<a id="__codelineno-1-13" name="__codelineno-1-13"></a>    <span style="color: #F8F8F2">block_timeliness:</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">boolean]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">field(default_factory</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">dict)</span>
<a id="__codelineno-1-14" name="__codelineno-1-14"></a>    <span style="color: #F8F8F2">checkpoint_states:</span> <span style="color: #F8F8F2">Dict[Checkpoint,</span> <span style="color: #F8F8F2">BeaconState]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">field(default_factory</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">dict)</span>
<a id="__codelineno-1-15" name="__codelineno-1-15"></a>    <span style="color: #F8F8F2">latest_messages:</span> <span style="color: #F8F8F2">Dict[ValidatorIndex,</span> <span style="color: #F8F8F2">LatestMessage]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">field(default_factory</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">dict)</span>
<a id="__codelineno-1-16" name="__codelineno-1-16"></a>    <span style="color: #F8F8F2">unrealized_justifications:</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">Checkpoint]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">field(default_factory</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">dict)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_forkchoice_store"><code>get_forkchoice_store</code><a class="headerlink" href="#get_forkchoice_store" title="Permanent link">&para;</a></h4>
<p>The provided anchor-state will be regarded as a trusted state, to not roll back
beyond. This should be the genesis state for a full client.</p>
<p><em>Note</em> With regards to fork choice, block headers are interchangeable with
blocks. The spec is likely to move to headers for reduced overhead in test
vectors and better encapsulation. Full implementations store blocks as part of
their database and will often use full blocks when dealing with production fork
choice.</p>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-18">18</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-19">19</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-20">20</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-2-21">21</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_forkchoice_store</span><span style="color: #F8F8F2">(anchor_state:</span> <span style="color: #F8F8F2">BeaconState,</span> <span style="color: #F8F8F2">anchor_block:</span> <span style="color: #F8F8F2">BeaconBlock)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Store:</span>
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">anchor_block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">state_root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">hash_tree_root(anchor_state)</span>
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>    <span style="color: #F8F8F2">anchor_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">hash_tree_root(anchor_block)</span>
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>    <span style="color: #F8F8F2">anchor_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_epoch(anchor_state)</span>
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>    <span style="color: #F8F8F2">justified_checkpoint</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Checkpoint(epoch</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">anchor_epoch,</span> <span style="color: #F8F8F2">root</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">anchor_root)</span>
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>    <span style="color: #F8F8F2">finalized_checkpoint</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Checkpoint(epoch</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">anchor_epoch,</span> <span style="color: #F8F8F2">root</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">anchor_root)</span>
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>    <span style="color: #F8F8F2">proposer_boost_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Root()</span>
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">Store(</span>
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>        <span style="color: #F8F8F2">time</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">uint64(anchor_state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">SECONDS_PER_SLOT</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">anchor_state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot),</span>
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>        <span style="color: #F8F8F2">genesis_time</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">anchor_state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time,</span>
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>        <span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">justified_checkpoint,</span>
<a id="__codelineno-2-12" name="__codelineno-2-12"></a>        <span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">finalized_checkpoint,</span>
<a id="__codelineno-2-13" name="__codelineno-2-13"></a>        <span style="color: #F8F8F2">unrealized_justified_checkpoint</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">justified_checkpoint,</span>
<a id="__codelineno-2-14" name="__codelineno-2-14"></a>        <span style="color: #F8F8F2">unrealized_finalized_checkpoint</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">finalized_checkpoint,</span>
<a id="__codelineno-2-15" name="__codelineno-2-15"></a>        <span style="color: #F8F8F2">proposer_boost_root</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">proposer_boost_root,</span>
<a id="__codelineno-2-16" name="__codelineno-2-16"></a>        <span style="color: #F8F8F2">equivocating_indices</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">set(),</span>
<a id="__codelineno-2-17" name="__codelineno-2-17"></a>        <span style="color: #F8F8F2">blocks</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">{anchor_root:</span> <span style="color: #F8F8F2">copy(anchor_block)},</span>
<a id="__codelineno-2-18" name="__codelineno-2-18"></a>        <span style="color: #F8F8F2">block_states</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">{anchor_root:</span> <span style="color: #F8F8F2">copy(anchor_state)},</span>
<a id="__codelineno-2-19" name="__codelineno-2-19"></a>        <span style="color: #F8F8F2">checkpoint_states</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">{justified_checkpoint:</span> <span style="color: #F8F8F2">copy(anchor_state)},</span>
<a id="__codelineno-2-20" name="__codelineno-2-20"></a>        <span style="color: #F8F8F2">unrealized_justifications</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">{anchor_root:</span> <span style="color: #F8F8F2">justified_checkpoint},</span>
<a id="__codelineno-2-21" name="__codelineno-2-21"></a>    <span style="color: #F8F8F2">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_slots_since_genesis"><code>get_slots_since_genesis</code><a class="headerlink" href="#get_slots_since_genesis" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-3-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-3-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_slots_since_genesis</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">int:</span>
<a id="__codelineno-3-2" name="__codelineno-3-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">time</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time)</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">SECONDS_PER_SLOT</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_current_slot"><code>get_current_slot</code><a class="headerlink" href="#get_current_slot" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-4-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-4-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_current_slot</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Slot:</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">Slot(GENESIS_SLOT</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">get_slots_since_genesis(store))</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_current_store_epoch"><code>get_current_store_epoch</code><a class="headerlink" href="#get_current_store_epoch" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-5-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-5-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_current_store_epoch</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Epoch:</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">compute_epoch_at_slot(get_current_slot(store))</span>
</code></pre></div></td></tr></table></div>
<h4 id="compute_slots_since_epoch_start"><code>compute_slots_since_epoch_start</code><a class="headerlink" href="#compute_slots_since_epoch_start" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-6-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-6-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">compute_slots_since_epoch_start</span><span style="color: #F8F8F2">(slot:</span> <span style="color: #F8F8F2">Slot)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">int:</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">compute_start_slot_at_epoch(compute_epoch_at_slot(slot))</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_ancestor"><code>get_ancestor</code><a class="headerlink" href="#get_ancestor" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-7-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-7-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-7-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-7-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-7-5">5</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_ancestor</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">root:</span> <span style="color: #F8F8F2">Root,</span> <span style="color: #F8F8F2">slot:</span> <span style="color: #F8F8F2">Slot)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Root:</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a>    <span style="color: #F8F8F2">block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[root]</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">slot:</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">get_ancestor(store,</span> <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root,</span> <span style="color: #F8F8F2">slot)</span>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">root</span>
</code></pre></div></td></tr></table></div>
<h4 id="calculate_committee_fraction"><code>calculate_committee_fraction</code><a class="headerlink" href="#calculate_committee_fraction" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-8-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-8-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-8-3">3</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">calculate_committee_fraction</span><span style="color: #F8F8F2">(state:</span> <span style="color: #F8F8F2">BeaconState,</span> <span style="color: #F8F8F2">committee_percent:</span> <span style="color: #F8F8F2">uint64)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Gwei:</span>
<a id="__codelineno-8-2" name="__codelineno-8-2"></a>    <span style="color: #F8F8F2">committee_weight</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_total_active_balance(state)</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">SLOTS_PER_EPOCH</span>
<a id="__codelineno-8-3" name="__codelineno-8-3"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">Gwei((committee_weight</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">committee_percent)</span> <span style="color: #FF4689">//</span> <span style="color: #AE81FF">100</span><span style="color: #F8F8F2">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_checkpoint_block"><code>get_checkpoint_block</code><a class="headerlink" href="#get_checkpoint_block" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-9-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-9-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-9-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-9-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-9-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-9-6">6</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_checkpoint_block</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">root:</span> <span style="color: #F8F8F2">Root,</span> <span style="color: #F8F8F2">epoch:</span> <span style="color: #F8F8F2">Epoch)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Root:</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-9-3" name="__codelineno-9-3"></a><span style="color: #E6DB74">    Compute the checkpoint block for epoch ``epoch`` in the chain of block ``root``</span>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>    <span style="color: #F8F8F2">epoch_first_slot</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">compute_start_slot_at_epoch(epoch)</span>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">get_ancestor(store,</span> <span style="color: #F8F8F2">root,</span> <span style="color: #F8F8F2">epoch_first_slot)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_proposer_score"><code>get_proposer_score</code><a class="headerlink" href="#get_proposer_score" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-10-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-10-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-10-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-10-4">4</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_proposer_score</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Gwei:</span>
<a id="__codelineno-10-2" name="__codelineno-10-2"></a>    <span style="color: #F8F8F2">justified_checkpoint_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states[store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint]</span>
<a id="__codelineno-10-3" name="__codelineno-10-3"></a>    <span style="color: #F8F8F2">committee_weight</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_total_active_balance(justified_checkpoint_state)</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">SLOTS_PER_EPOCH</span>
<a id="__codelineno-10-4" name="__codelineno-10-4"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(committee_weight</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">PROPOSER_SCORE_BOOST)</span> <span style="color: #FF4689">//</span> <span style="color: #AE81FF">100</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_weight"><code>get_weight</code><a class="headerlink" href="#get_weight" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-18">18</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-19">19</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-20">20</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-21">21</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-22">22</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-23">23</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-24">24</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-25">25</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-26">26</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-27">27</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-28">28</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-11-29">29</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_weight</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Gwei:</span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a>    <span style="color: #F8F8F2">state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states[store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint]</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a>    <span style="color: #F8F8F2">unslashed_and_active_indices</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a>        <span style="color: #F8F8F2">i</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a>        <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">get_active_validator_indices(state,</span> <span style="color: #F8F8F2">get_current_epoch(state))</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a>        <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">validators[i]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slashed</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>    <span style="color: #F8F8F2">]</span>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a>    <span style="color: #F8F8F2">attestation_score</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Gwei(</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>        <span style="color: #F8F8F2">sum(</span>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a>            <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">validators[i]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">effective_balance</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a>            <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">unslashed_and_active_indices</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a>            <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">(</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a>                <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">latest_messages</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a>                <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">not</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">equivocating_indices</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a>                <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">get_ancestor(store,</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">latest_messages[i]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root,</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot)</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a>                <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">root</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a>            <span style="color: #F8F8F2">)</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>        <span style="color: #F8F8F2">)</span>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">proposer_boost_root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">Root():</span>
<a id="__codelineno-11-21" name="__codelineno-11-21"></a>        <span style="color: #959077"># Return only attestation score if ``proposer_boost_root`` is not set</span>
<a id="__codelineno-11-22" name="__codelineno-11-22"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">attestation_score</span>
<a id="__codelineno-11-23" name="__codelineno-11-23"></a>
<a id="__codelineno-11-24" name="__codelineno-11-24"></a>    <span style="color: #959077"># Calculate proposer score if ``proposer_boost_root`` is set</span>
<a id="__codelineno-11-25" name="__codelineno-11-25"></a>    <span style="color: #F8F8F2">proposer_score</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Gwei(</span><span style="color: #AE81FF">0</span><span style="color: #F8F8F2">)</span>
<a id="__codelineno-11-26" name="__codelineno-11-26"></a>    <span style="color: #959077"># Boost is applied if ``root`` is an ancestor of ``proposer_boost_root``</span>
<a id="__codelineno-11-27" name="__codelineno-11-27"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">get_ancestor(store,</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">proposer_boost_root,</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot)</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">root:</span>
<a id="__codelineno-11-28" name="__codelineno-11-28"></a>        <span style="color: #F8F8F2">proposer_score</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_proposer_score(store)</span>
<a id="__codelineno-11-29" name="__codelineno-11-29"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">attestation_score</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">proposer_score</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_voting_source"><code>get_voting_source</code><a class="headerlink" href="#get_voting_source" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-12-14">14</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_voting_source</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">block_root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Checkpoint:</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a><span style="color: #E6DB74">    Compute the voting source checkpoint in event that block with root ``block_root`` is the head block</span>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a>    <span style="color: #F8F8F2">block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[block_root]</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a>    <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_store_epoch(store)</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a>    <span style="color: #F8F8F2">block_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">compute_epoch_at_slot(block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot)</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">block_epoch:</span>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a>        <span style="color: #959077"># The block is from a prior epoch, the voting source will be pulled-up</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justifications[block_root]</span>
<a id="__codelineno-12-11" name="__codelineno-12-11"></a>    <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-12-12" name="__codelineno-12-12"></a>        <span style="color: #959077"># The block is not from a prior epoch, therefore the voting source is not pulled up</span>
<a id="__codelineno-12-13" name="__codelineno-12-13"></a>        <span style="color: #F8F8F2">head_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states[block_root]</span>
<a id="__codelineno-12-14" name="__codelineno-12-14"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">head_state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">current_justified_checkpoint</span>
</code></pre></div></td></tr></table></div>
<h4 id="filter_block_tree"><code>filter_block_tree</code><a class="headerlink" href="#filter_block_tree" title="Permanent link">&para;</a></h4>
<p><em>Note</em>: External calls to <code>filter_block_tree</code> (i.e., any calls that are not made
by the recursive logic in this function) MUST set <code>block_root</code> to
<code>store.justified_checkpoint.root</code>.</p>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-18">18</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-19">19</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-20">20</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-21">21</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-22">22</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-23">23</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-24">24</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-25">25</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-26">26</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-27">27</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-28">28</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-29">29</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-30">30</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-31">31</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-32">32</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-33">33</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-34">34</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-35">35</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-36">36</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-37">37</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-38">38</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-39">39</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-40">40</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-41">41</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-42">42</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-43">43</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-13-44">44</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">filter_block_tree</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">block_root:</span> <span style="color: #F8F8F2">Root,</span> <span style="color: #F8F8F2">blocks:</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">BeaconBlock])</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-13-2" name="__codelineno-13-2"></a>    <span style="color: #F8F8F2">block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[block_root]</span>
<a id="__codelineno-13-3" name="__codelineno-13-3"></a>    <span style="color: #F8F8F2">children</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[</span>
<a id="__codelineno-13-4" name="__codelineno-13-4"></a>        <span style="color: #F8F8F2">root</span> <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">root</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">keys()</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">block_root</span>
<a id="__codelineno-13-5" name="__codelineno-13-5"></a>    <span style="color: #F8F8F2">]</span>
<a id="__codelineno-13-6" name="__codelineno-13-6"></a>
<a id="__codelineno-13-7" name="__codelineno-13-7"></a>    <span style="color: #959077"># If any children branches contain expected finalized/justified checkpoints,</span>
<a id="__codelineno-13-8" name="__codelineno-13-8"></a>    <span style="color: #959077"># add to filtered block-tree and signal viability to parent.</span>
<a id="__codelineno-13-9" name="__codelineno-13-9"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">any(children):</span>
<a id="__codelineno-13-10" name="__codelineno-13-10"></a>        <span style="color: #F8F8F2">filter_block_tree_result</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[filter_block_tree(store,</span> <span style="color: #F8F8F2">child,</span> <span style="color: #F8F8F2">blocks)</span> <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">child</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">children]</span>
<a id="__codelineno-13-11" name="__codelineno-13-11"></a>        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">any(filter_block_tree_result):</span>
<a id="__codelineno-13-12" name="__codelineno-13-12"></a>            <span style="color: #F8F8F2">blocks[block_root]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">block</span>
<a id="__codelineno-13-13" name="__codelineno-13-13"></a>            <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">True</span>
<a id="__codelineno-13-14" name="__codelineno-13-14"></a>        <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">False</span>
<a id="__codelineno-13-15" name="__codelineno-13-15"></a>
<a id="__codelineno-13-16" name="__codelineno-13-16"></a>    <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_store_epoch(store)</span>
<a id="__codelineno-13-17" name="__codelineno-13-17"></a>    <span style="color: #F8F8F2">voting_source</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_voting_source(store,</span> <span style="color: #F8F8F2">block_root)</span>
<a id="__codelineno-13-18" name="__codelineno-13-18"></a>
<a id="__codelineno-13-19" name="__codelineno-13-19"></a>    <span style="color: #959077"># The voting source should be either at the same height as the store&#39;s justified checkpoint or</span>
<a id="__codelineno-13-20" name="__codelineno-13-20"></a>    <span style="color: #959077"># not more than two epochs ago</span>
<a id="__codelineno-13-21" name="__codelineno-13-21"></a>    <span style="color: #F8F8F2">correct_justified</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span>
<a id="__codelineno-13-22" name="__codelineno-13-22"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">GENESIS_EPOCH</span>
<a id="__codelineno-13-23" name="__codelineno-13-23"></a>        <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">voting_source</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span>
<a id="__codelineno-13-24" name="__codelineno-13-24"></a>        <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">voting_source</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">2</span> <span style="color: #FF4689">&gt;=</span> <span style="color: #F8F8F2">current_epoch</span>
<a id="__codelineno-13-25" name="__codelineno-13-25"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-13-26" name="__codelineno-13-26"></a>
<a id="__codelineno-13-27" name="__codelineno-13-27"></a>    <span style="color: #F8F8F2">finalized_checkpoint_block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_checkpoint_block(</span>
<a id="__codelineno-13-28" name="__codelineno-13-28"></a>        <span style="color: #F8F8F2">store,</span>
<a id="__codelineno-13-29" name="__codelineno-13-29"></a>        <span style="color: #F8F8F2">block_root,</span>
<a id="__codelineno-13-30" name="__codelineno-13-30"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch,</span>
<a id="__codelineno-13-31" name="__codelineno-13-31"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-13-32" name="__codelineno-13-32"></a>
<a id="__codelineno-13-33" name="__codelineno-13-33"></a>    <span style="color: #F8F8F2">correct_finalized</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(</span>
<a id="__codelineno-13-34" name="__codelineno-13-34"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">GENESIS_EPOCH</span>
<a id="__codelineno-13-35" name="__codelineno-13-35"></a>        <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">finalized_checkpoint_block</span>
<a id="__codelineno-13-36" name="__codelineno-13-36"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-13-37" name="__codelineno-13-37"></a>
<a id="__codelineno-13-38" name="__codelineno-13-38"></a>    <span style="color: #959077"># If expected finalized/justified, add to viable block-tree and signal viability to parent.</span>
<a id="__codelineno-13-39" name="__codelineno-13-39"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">correct_justified</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">correct_finalized:</span>
<a id="__codelineno-13-40" name="__codelineno-13-40"></a>        <span style="color: #F8F8F2">blocks[block_root]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">block</span>
<a id="__codelineno-13-41" name="__codelineno-13-41"></a>        <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">True</span>
<a id="__codelineno-13-42" name="__codelineno-13-42"></a>
<a id="__codelineno-13-43" name="__codelineno-13-43"></a>    <span style="color: #959077"># Otherwise, branch not viable</span>
<a id="__codelineno-13-44" name="__codelineno-13-44"></a>    <span style="color: #66D9EF">return</span> <span style="color: #66D9EF">False</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_filtered_block_tree"><code>get_filtered_block_tree</code><a class="headerlink" href="#get_filtered_block_tree" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-6">6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-7">7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-8">8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-14-9">9</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_filtered_block_tree</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">BeaconBlock]:</span>
<a id="__codelineno-14-2" name="__codelineno-14-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-14-3" name="__codelineno-14-3"></a><span style="color: #E6DB74">    Retrieve a filtered block tree from ``store``, only returning branches</span>
<a id="__codelineno-14-4" name="__codelineno-14-4"></a><span style="color: #E6DB74">    whose leaf state&#39;s justified/finalized info agrees with that in ``store``.</span>
<a id="__codelineno-14-5" name="__codelineno-14-5"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-14-6" name="__codelineno-14-6"></a>    <span style="color: #F8F8F2">base</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root</span>
<a id="__codelineno-14-7" name="__codelineno-14-7"></a>    <span style="color: #F8F8F2">blocks:</span> <span style="color: #F8F8F2">Dict[Root,</span> <span style="color: #F8F8F2">BeaconBlock]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">{}</span>
<a id="__codelineno-14-8" name="__codelineno-14-8"></a>    <span style="color: #F8F8F2">filter_block_tree(store,</span> <span style="color: #F8F8F2">base,</span> <span style="color: #F8F8F2">blocks)</span>
<a id="__codelineno-14-9" name="__codelineno-14-9"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">blocks</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_head"><code>get_head</code><a class="headerlink" href="#get_head" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-15-12">12</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_head</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Root:</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a>    <span style="color: #959077"># Get filtered block tree that only includes viable branches</span>
<a id="__codelineno-15-3" name="__codelineno-15-3"></a>    <span style="color: #F8F8F2">blocks</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_filtered_block_tree(store)</span>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a>    <span style="color: #959077"># Execute the LMD-GHOST fork choice</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>    <span style="color: #F8F8F2">head</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root</span>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a>    <span style="color: #66D9EF">while</span> <span style="color: #66D9EF">True</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-15-7" name="__codelineno-15-7"></a>        <span style="color: #F8F8F2">children</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[root</span> <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">root</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">blocks</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">keys()</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">blocks[root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">head]</span>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a>        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">len(children)</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a>            <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">head</span>
<a id="__codelineno-15-10" name="__codelineno-15-10"></a>        <span style="color: #959077"># Sort by latest attesting balance with ties broken lexicographically</span>
<a id="__codelineno-15-11" name="__codelineno-15-11"></a>        <span style="color: #959077"># Ties broken by favoring block with lexicographically higher root</span>
<a id="__codelineno-15-12" name="__codelineno-15-12"></a>        <span style="color: #F8F8F2">head</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">max(children,</span> <span style="color: #F8F8F2">key</span><span style="color: #FF4689">=</span><span style="color: #66D9EF">lambda</span> <span style="color: #F8F8F2">root:</span> <span style="color: #F8F8F2">(get_weight(store,</span> <span style="color: #F8F8F2">root),</span> <span style="color: #F8F8F2">root))</span>
</code></pre></div></td></tr></table></div>
<h4 id="update_checkpoints"><code>update_checkpoints</code><a class="headerlink" href="#update_checkpoints" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-16-13">13</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">update_checkpoints</span><span style="color: #F8F8F2">(</span>
<a id="__codelineno-16-2" name="__codelineno-16-2"></a>    <span style="color: #F8F8F2">store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">justified_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint,</span> <span style="color: #F8F8F2">finalized_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint</span>
<a id="__codelineno-16-3" name="__codelineno-16-3"></a><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-16-4" name="__codelineno-16-4"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-16-5" name="__codelineno-16-5"></a><span style="color: #E6DB74">    Update checkpoints in store if necessary</span>
<a id="__codelineno-16-6" name="__codelineno-16-6"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-16-7" name="__codelineno-16-7"></a>    <span style="color: #959077"># Update justified checkpoint</span>
<a id="__codelineno-16-8" name="__codelineno-16-8"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch:</span>
<a id="__codelineno-16-9" name="__codelineno-16-9"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">justified_checkpoint</span>
<a id="__codelineno-16-10" name="__codelineno-16-10"></a>
<a id="__codelineno-16-11" name="__codelineno-16-11"></a>    <span style="color: #959077"># Update finalized checkpoint</span>
<a id="__codelineno-16-12" name="__codelineno-16-12"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch:</span>
<a id="__codelineno-16-13" name="__codelineno-16-13"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">finalized_checkpoint</span>
</code></pre></div></td></tr></table></div>
<h4 id="update_unrealized_checkpoints"><code>update_unrealized_checkpoints</code><a class="headerlink" href="#update_unrealized_checkpoints" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-17-15">15</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">update_unrealized_checkpoints</span><span style="color: #F8F8F2">(</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a>    <span style="color: #F8F8F2">store:</span> <span style="color: #F8F8F2">Store,</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a>    <span style="color: #F8F8F2">unrealized_justified_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint,</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a>    <span style="color: #F8F8F2">unrealized_finalized_checkpoint:</span> <span style="color: #F8F8F2">Checkpoint,</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span style="color: #E6DB74">    Update unrealized checkpoints in store if necessary</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-17-9" name="__codelineno-17-9"></a>    <span style="color: #959077"># Update unrealized justified checkpoint</span>
<a id="__codelineno-17-10" name="__codelineno-17-10"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">unrealized_justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch:</span>
<a id="__codelineno-17-11" name="__codelineno-17-11"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justified_checkpoint</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">unrealized_justified_checkpoint</span>
<a id="__codelineno-17-12" name="__codelineno-17-12"></a>
<a id="__codelineno-17-13" name="__codelineno-17-13"></a>    <span style="color: #959077"># Update unrealized finalized checkpoint</span>
<a id="__codelineno-17-14" name="__codelineno-17-14"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">unrealized_finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch:</span>
<a id="__codelineno-17-15" name="__codelineno-17-15"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_finalized_checkpoint</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">unrealized_finalized_checkpoint</span>
</code></pre></div></td></tr></table></div>
<h4 id="seconds_to_milliseconds"><code>seconds_to_milliseconds</code><a class="headerlink" href="#seconds_to_milliseconds" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-6">6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-7">7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-18-8">8</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">seconds_to_milliseconds</span><span style="color: #F8F8F2">(seconds:</span> <span style="color: #F8F8F2">uint64)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">uint64:</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span style="color: #E6DB74">    Convert seconds to milliseconds with overflow protection.</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span style="color: #E6DB74">    Returns ``UINT64_MAX`` if the result would overflow.</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">seconds</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">UINT64_MAX</span> <span style="color: #FF4689">//</span> <span style="color: #AE81FF">1000</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">UINT64_MAX</span>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">seconds</span> <span style="color: #FF4689">*</span> <span style="color: #AE81FF">1000</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_slot_component_duration_ms"><code>get_slot_component_duration_ms</code><a class="headerlink" href="#get_slot_component_duration_ms" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-19-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-19-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-19-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-19-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-19-5">5</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_slot_component_duration_ms</span><span style="color: #F8F8F2">(basis_points:</span> <span style="color: #F8F8F2">uint64)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">uint64:</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span style="color: #E6DB74">    Calculate the duration of a slot component in milliseconds.</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">basis_points</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">SLOT_DURATION_MS</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">BASIS_POINTS</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_attestation_due_ms"><code>get_attestation_due_ms</code><a class="headerlink" href="#get_attestation_due_ms" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-20-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-20-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_attestation_due_ms</span><span style="color: #F8F8F2">(epoch:</span> <span style="color: #F8F8F2">Epoch)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">uint64:</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">get_slot_component_duration_ms(ATTESTATION_DUE_BPS)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_proposer_reorg_cutoff_ms"><code>get_proposer_reorg_cutoff_ms</code><a class="headerlink" href="#get_proposer_reorg_cutoff_ms" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-21-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-21-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-21-1" name="__codelineno-21-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_proposer_reorg_cutoff_ms</span><span style="color: #F8F8F2">(epoch:</span> <span style="color: #F8F8F2">Epoch)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">uint64:</span>
<a id="__codelineno-21-2" name="__codelineno-21-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">get_slot_component_duration_ms(PROPOSER_REORG_CUTOFF_BPS)</span>
</code></pre></div></td></tr></table></div>
<h4 id="get_aggregate_due_ms"><code>get_aggregate_due_ms</code><a class="headerlink" href="#get_aggregate_due_ms" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-22-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-22-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-22-1" name="__codelineno-22-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_aggregate_due_ms</span><span style="color: #F8F8F2">(epoch:</span> <span style="color: #F8F8F2">Epoch)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">uint64:</span>
<a id="__codelineno-22-2" name="__codelineno-22-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">get_slot_component_duration_ms(AGGREGATE_DUE_BPS)</span>
</code></pre></div></td></tr></table></div>
<h4 id="proposer-head-and-reorg-helpers">Proposer head and reorg helpers<a class="headerlink" href="#proposer-head-and-reorg-helpers" title="Permanent link">&para;</a></h4>
<p><em>Implementing these helpers is optional</em>.</p>
<h5 id="is_head_late"><code>is_head_late</code><a class="headerlink" href="#is_head_late" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-23-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-23-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-23-1" name="__codelineno-23-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_head_late</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">head_root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-23-2" name="__codelineno-23-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_timeliness[head_root]</span>
</code></pre></div></td></tr></table></div>
<h5 id="is_shuffling_stable"><code>is_shuffling_stable</code><a class="headerlink" href="#is_shuffling_stable" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-24-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-24-2">2</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-24-1" name="__codelineno-24-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_shuffling_stable</span><span style="color: #F8F8F2">(slot:</span> <span style="color: #F8F8F2">Slot)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-24-2" name="__codelineno-24-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">%</span> <span style="color: #F8F8F2">SLOTS_PER_EPOCH</span> <span style="color: #FF4689">!=</span> <span style="color: #AE81FF">0</span>
</code></pre></div></td></tr></table></div>
<h5 id="is_ffg_competitive"><code>is_ffg_competitive</code><a class="headerlink" href="#is_ffg_competitive" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-25-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-25-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-25-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-25-4">4</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-25-1" name="__codelineno-25-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_ffg_competitive</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">head_root:</span> <span style="color: #F8F8F2">Root,</span> <span style="color: #F8F8F2">parent_root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-25-2" name="__codelineno-25-2"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">(</span>
<a id="__codelineno-25-3" name="__codelineno-25-3"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justifications[head_root]</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justifications[parent_root]</span>
<a id="__codelineno-25-4" name="__codelineno-25-4"></a>    <span style="color: #F8F8F2">)</span>
</code></pre></div></td></tr></table></div>
<h5 id="is_finalization_ok"><code>is_finalization_ok</code><a class="headerlink" href="#is_finalization_ok" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-26-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-26-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-26-3">3</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-26-1" name="__codelineno-26-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_finalization_ok</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">slot:</span> <span style="color: #F8F8F2">Slot)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-26-2" name="__codelineno-26-2"></a>    <span style="color: #F8F8F2">epochs_since_finalization</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">compute_epoch_at_slot(slot)</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span>
<a id="__codelineno-26-3" name="__codelineno-26-3"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">epochs_since_finalization</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #F8F8F2">REORG_MAX_EPOCHS_SINCE_FINALIZATION</span>
</code></pre></div></td></tr></table></div>
<h5 id="is_proposing_on_time"><code>is_proposing_on_time</code><a class="headerlink" href="#is_proposing_on_time" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-27-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-27-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-27-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-27-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-27-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-27-6">6</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-27-1" name="__codelineno-27-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_proposing_on_time</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-27-2" name="__codelineno-27-2"></a>    <span style="color: #F8F8F2">seconds_since_genesis</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">time</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time</span>
<a id="__codelineno-27-3" name="__codelineno-27-3"></a>    <span style="color: #F8F8F2">time_into_slot_ms</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">seconds_to_milliseconds(seconds_since_genesis)</span> <span style="color: #FF4689">%</span> <span style="color: #F8F8F2">SLOT_DURATION_MS</span>
<a id="__codelineno-27-4" name="__codelineno-27-4"></a>    <span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_store_epoch(store)</span>
<a id="__codelineno-27-5" name="__codelineno-27-5"></a>    <span style="color: #F8F8F2">proposer_reorg_cutoff_ms</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_proposer_reorg_cutoff_ms(epoch)</span>
<a id="__codelineno-27-6" name="__codelineno-27-6"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">time_into_slot_ms</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #F8F8F2">proposer_reorg_cutoff_ms</span>
</code></pre></div></td></tr></table></div>
<h5 id="is_head_weak"><code>is_head_weak</code><a class="headerlink" href="#is_head_weak" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-28-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-28-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-28-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-28-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-28-5">5</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-28-1" name="__codelineno-28-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_head_weak</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">head_root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-28-2" name="__codelineno-28-2"></a>    <span style="color: #F8F8F2">justified_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states[store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint]</span>
<a id="__codelineno-28-3" name="__codelineno-28-3"></a>    <span style="color: #F8F8F2">reorg_threshold</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">calculate_committee_fraction(justified_state,</span> <span style="color: #F8F8F2">REORG_HEAD_WEIGHT_THRESHOLD)</span>
<a id="__codelineno-28-4" name="__codelineno-28-4"></a>    <span style="color: #F8F8F2">head_weight</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_weight(store,</span> <span style="color: #F8F8F2">head_root)</span>
<a id="__codelineno-28-5" name="__codelineno-28-5"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">head_weight</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">reorg_threshold</span>
</code></pre></div></td></tr></table></div>
<h5 id="is_parent_strong"><code>is_parent_strong</code><a class="headerlink" href="#is_parent_strong" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-29-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-29-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-29-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-29-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-29-5">5</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-29-1" name="__codelineno-29-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">is_parent_strong</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">parent_root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">bool:</span>
<a id="__codelineno-29-2" name="__codelineno-29-2"></a>    <span style="color: #F8F8F2">justified_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states[store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint]</span>
<a id="__codelineno-29-3" name="__codelineno-29-3"></a>    <span style="color: #F8F8F2">parent_threshold</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">calculate_committee_fraction(justified_state,</span> <span style="color: #F8F8F2">REORG_PARENT_WEIGHT_THRESHOLD)</span>
<a id="__codelineno-29-4" name="__codelineno-29-4"></a>    <span style="color: #F8F8F2">parent_weight</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_weight(store,</span> <span style="color: #F8F8F2">parent_root)</span>
<a id="__codelineno-29-5" name="__codelineno-29-5"></a>    <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">parent_weight</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">parent_threshold</span>
</code></pre></div></td></tr></table></div>
<h5 id="get_proposer_head"><code>get_proposer_head</code><a class="headerlink" href="#get_proposer_head" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-18">18</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-19">19</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-20">20</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-21">21</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-22">22</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-23">23</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-24">24</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-25">25</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-26">26</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-27">27</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-28">28</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-29">29</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-30">30</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-31">31</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-32">32</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-33">33</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-34">34</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-35">35</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-36">36</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-37">37</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-38">38</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-39">39</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-40">40</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-41">41</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-42">42</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-43">43</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-44">44</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-45">45</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-46">46</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-47">47</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-30-48">48</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-30-1" name="__codelineno-30-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">get_proposer_head</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">head_root:</span> <span style="color: #F8F8F2">Root,</span> <span style="color: #F8F8F2">slot:</span> <span style="color: #F8F8F2">Slot)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #F8F8F2">Root:</span>
<a id="__codelineno-30-2" name="__codelineno-30-2"></a>    <span style="color: #F8F8F2">head_block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[head_root]</span>
<a id="__codelineno-30-3" name="__codelineno-30-3"></a>    <span style="color: #F8F8F2">parent_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">head_block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root</span>
<a id="__codelineno-30-4" name="__codelineno-30-4"></a>    <span style="color: #F8F8F2">parent_block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[parent_root]</span>
<a id="__codelineno-30-5" name="__codelineno-30-5"></a>
<a id="__codelineno-30-6" name="__codelineno-30-6"></a>    <span style="color: #959077"># Only re-org the head block if it arrived later than the attestation deadline.</span>
<a id="__codelineno-30-7" name="__codelineno-30-7"></a>    <span style="color: #F8F8F2">head_late</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_head_late(store,</span> <span style="color: #F8F8F2">head_root)</span>
<a id="__codelineno-30-8" name="__codelineno-30-8"></a>
<a id="__codelineno-30-9" name="__codelineno-30-9"></a>    <span style="color: #959077"># Do not re-org on an epoch boundary where the proposer shuffling could change.</span>
<a id="__codelineno-30-10" name="__codelineno-30-10"></a>    <span style="color: #F8F8F2">shuffling_stable</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_shuffling_stable(slot)</span>
<a id="__codelineno-30-11" name="__codelineno-30-11"></a>
<a id="__codelineno-30-12" name="__codelineno-30-12"></a>    <span style="color: #959077"># Ensure that the FFG information of the new head will be competitive with the current head.</span>
<a id="__codelineno-30-13" name="__codelineno-30-13"></a>    <span style="color: #F8F8F2">ffg_competitive</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_ffg_competitive(store,</span> <span style="color: #F8F8F2">head_root,</span> <span style="color: #F8F8F2">parent_root)</span>
<a id="__codelineno-30-14" name="__codelineno-30-14"></a>
<a id="__codelineno-30-15" name="__codelineno-30-15"></a>    <span style="color: #959077"># Do not re-org if the chain is not finalizing with acceptable frequency.</span>
<a id="__codelineno-30-16" name="__codelineno-30-16"></a>    <span style="color: #F8F8F2">finalization_ok</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_finalization_ok(store,</span> <span style="color: #F8F8F2">slot)</span>
<a id="__codelineno-30-17" name="__codelineno-30-17"></a>
<a id="__codelineno-30-18" name="__codelineno-30-18"></a>    <span style="color: #959077"># Only re-org if we are proposing on-time.</span>
<a id="__codelineno-30-19" name="__codelineno-30-19"></a>    <span style="color: #F8F8F2">proposing_on_time</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_proposing_on_time(store)</span>
<a id="__codelineno-30-20" name="__codelineno-30-20"></a>
<a id="__codelineno-30-21" name="__codelineno-30-21"></a>    <span style="color: #959077"># Only re-org a single slot at most.</span>
<a id="__codelineno-30-22" name="__codelineno-30-22"></a>    <span style="color: #F8F8F2">parent_slot_ok</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">parent_block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">head_block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span>
<a id="__codelineno-30-23" name="__codelineno-30-23"></a>    <span style="color: #F8F8F2">current_time_ok</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">head_block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">slot</span>
<a id="__codelineno-30-24" name="__codelineno-30-24"></a>    <span style="color: #F8F8F2">single_slot_reorg</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">parent_slot_ok</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">current_time_ok</span>
<a id="__codelineno-30-25" name="__codelineno-30-25"></a>
<a id="__codelineno-30-26" name="__codelineno-30-26"></a>    <span style="color: #959077"># Check that the head has few enough votes to be overpowered by our proposer boost.</span>
<a id="__codelineno-30-27" name="__codelineno-30-27"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">proposer_boost_root</span> <span style="color: #FF4689">!=</span> <span style="color: #F8F8F2">head_root</span>  <span style="color: #959077"># ensure boost has worn off</span>
<a id="__codelineno-30-28" name="__codelineno-30-28"></a>    <span style="color: #F8F8F2">head_weak</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_head_weak(store,</span> <span style="color: #F8F8F2">head_root)</span>
<a id="__codelineno-30-29" name="__codelineno-30-29"></a>
<a id="__codelineno-30-30" name="__codelineno-30-30"></a>    <span style="color: #959077"># Check that the missing votes are assigned to the parent and not being hoarded.</span>
<a id="__codelineno-30-31" name="__codelineno-30-31"></a>    <span style="color: #F8F8F2">parent_strong</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_parent_strong(store,</span> <span style="color: #F8F8F2">parent_root)</span>
<a id="__codelineno-30-32" name="__codelineno-30-32"></a>
<a id="__codelineno-30-33" name="__codelineno-30-33"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">all(</span>
<a id="__codelineno-30-34" name="__codelineno-30-34"></a>        <span style="color: #F8F8F2">[</span>
<a id="__codelineno-30-35" name="__codelineno-30-35"></a>            <span style="color: #F8F8F2">head_late,</span>
<a id="__codelineno-30-36" name="__codelineno-30-36"></a>            <span style="color: #F8F8F2">shuffling_stable,</span>
<a id="__codelineno-30-37" name="__codelineno-30-37"></a>            <span style="color: #F8F8F2">ffg_competitive,</span>
<a id="__codelineno-30-38" name="__codelineno-30-38"></a>            <span style="color: #F8F8F2">finalization_ok,</span>
<a id="__codelineno-30-39" name="__codelineno-30-39"></a>            <span style="color: #F8F8F2">proposing_on_time,</span>
<a id="__codelineno-30-40" name="__codelineno-30-40"></a>            <span style="color: #F8F8F2">single_slot_reorg,</span>
<a id="__codelineno-30-41" name="__codelineno-30-41"></a>            <span style="color: #F8F8F2">head_weak,</span>
<a id="__codelineno-30-42" name="__codelineno-30-42"></a>            <span style="color: #F8F8F2">parent_strong,</span>
<a id="__codelineno-30-43" name="__codelineno-30-43"></a>        <span style="color: #F8F8F2">]</span>
<a id="__codelineno-30-44" name="__codelineno-30-44"></a>    <span style="color: #F8F8F2">):</span>
<a id="__codelineno-30-45" name="__codelineno-30-45"></a>        <span style="color: #959077"># We can re-org the current head by building upon its parent block.</span>
<a id="__codelineno-30-46" name="__codelineno-30-46"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">parent_root</span>
<a id="__codelineno-30-47" name="__codelineno-30-47"></a>    <span style="color: #66D9EF">else</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-30-48" name="__codelineno-30-48"></a>        <span style="color: #66D9EF">return</span> <span style="color: #F8F8F2">head_root</span>
</code></pre></div></td></tr></table></div>
<p><em>Note</em>: The ordering of conditions is a suggestion only. Implementations are
free to optimize by re-ordering the conditions from least to most expensive and
by returning early if any of the early conditions are <code>False</code>.</p>
<h4 id="pull-up-tip-helpers">Pull-up tip helpers<a class="headerlink" href="#pull-up-tip-helpers" title="Permanent link">&para;</a></h4>
<h5 id="compute_pulled_up_tip"><code>compute_pulled_up_tip</code><a class="headerlink" href="#compute_pulled_up_tip" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-31-15">15</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-31-1" name="__codelineno-31-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">compute_pulled_up_tip</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">block_root:</span> <span style="color: #F8F8F2">Root)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-31-2" name="__codelineno-31-2"></a>    <span style="color: #F8F8F2">state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states[block_root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">copy()</span>
<a id="__codelineno-31-3" name="__codelineno-31-3"></a>    <span style="color: #959077"># Pull up the post-state of the block to the next epoch boundary</span>
<a id="__codelineno-31-4" name="__codelineno-31-4"></a>    <span style="color: #F8F8F2">process_justification_and_finalization(state)</span>
<a id="__codelineno-31-5" name="__codelineno-31-5"></a>
<a id="__codelineno-31-6" name="__codelineno-31-6"></a>    <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justifications[block_root]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">current_justified_checkpoint</span>
<a id="__codelineno-31-7" name="__codelineno-31-7"></a>    <span style="color: #F8F8F2">update_unrealized_checkpoints(</span>
<a id="__codelineno-31-8" name="__codelineno-31-8"></a>        <span style="color: #F8F8F2">store,</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">current_justified_checkpoint,</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span>
<a id="__codelineno-31-9" name="__codelineno-31-9"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-31-10" name="__codelineno-31-10"></a>
<a id="__codelineno-31-11" name="__codelineno-31-11"></a>    <span style="color: #959077"># If the block is from a prior epoch, apply the realized values</span>
<a id="__codelineno-31-12" name="__codelineno-31-12"></a>    <span style="color: #F8F8F2">block_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">compute_epoch_at_slot(store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[block_root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot)</span>
<a id="__codelineno-31-13" name="__codelineno-31-13"></a>    <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_store_epoch(store)</span>
<a id="__codelineno-31-14" name="__codelineno-31-14"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">block_epoch</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">current_epoch:</span>
<a id="__codelineno-31-15" name="__codelineno-31-15"></a>        <span style="color: #F8F8F2">update_checkpoints(store,</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">current_justified_checkpoint,</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint)</span>
</code></pre></div></td></tr></table></div>
<h4 id="on_tick-helpers"><code>on_tick</code> helpers<a class="headerlink" href="#on_tick-helpers" title="Permanent link">&para;</a></h4>
<h5 id="on_tick_per_slot"><code>on_tick_per_slot</code><a class="headerlink" href="#on_tick_per_slot" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-32-17">17</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-32-1" name="__codelineno-32-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">on_tick_per_slot</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">time:</span> <span style="color: #F8F8F2">uint64)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-32-2" name="__codelineno-32-2"></a>    <span style="color: #F8F8F2">previous_slot</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_slot(store)</span>
<a id="__codelineno-32-3" name="__codelineno-32-3"></a>
<a id="__codelineno-32-4" name="__codelineno-32-4"></a>    <span style="color: #959077"># Update store time</span>
<a id="__codelineno-32-5" name="__codelineno-32-5"></a>    <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">time</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">time</span>
<a id="__codelineno-32-6" name="__codelineno-32-6"></a>
<a id="__codelineno-32-7" name="__codelineno-32-7"></a>    <span style="color: #F8F8F2">current_slot</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_slot(store)</span>
<a id="__codelineno-32-8" name="__codelineno-32-8"></a>
<a id="__codelineno-32-9" name="__codelineno-32-9"></a>    <span style="color: #959077"># If this is a new slot, reset store.proposer_boost_root</span>
<a id="__codelineno-32-10" name="__codelineno-32-10"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">current_slot</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">previous_slot:</span>
<a id="__codelineno-32-11" name="__codelineno-32-11"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">proposer_boost_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">Root()</span>
<a id="__codelineno-32-12" name="__codelineno-32-12"></a>
<a id="__codelineno-32-13" name="__codelineno-32-13"></a>    <span style="color: #959077"># If a new epoch, pull-up justification and finalization from previous epoch</span>
<a id="__codelineno-32-14" name="__codelineno-32-14"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">current_slot</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">previous_slot</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">compute_slots_since_epoch_start(current_slot)</span> <span style="color: #FF4689">==</span> <span style="color: #AE81FF">0</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-32-15" name="__codelineno-32-15"></a>        <span style="color: #F8F8F2">update_checkpoints(</span>
<a id="__codelineno-32-16" name="__codelineno-32-16"></a>            <span style="color: #F8F8F2">store,</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_justified_checkpoint,</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">unrealized_finalized_checkpoint</span>
<a id="__codelineno-32-17" name="__codelineno-32-17"></a>        <span style="color: #F8F8F2">)</span>
</code></pre></div></td></tr></table></div>
<h4 id="on_attestation-helpers"><code>on_attestation</code> helpers<a class="headerlink" href="#on_attestation-helpers" title="Permanent link">&para;</a></h4>
<h5 id="validate_target_epoch_against_current_time"><code>validate_target_epoch_against_current_time</code><a class="headerlink" href="#validate_target_epoch_against_current_time" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-6">6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-7">7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-8">8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-33-9">9</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-33-1" name="__codelineno-33-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">validate_target_epoch_against_current_time</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">attestation:</span> <span style="color: #F8F8F2">Attestation)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-33-2" name="__codelineno-33-2"></a>    <span style="color: #F8F8F2">target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target</span>
<a id="__codelineno-33-3" name="__codelineno-33-3"></a>
<a id="__codelineno-33-4" name="__codelineno-33-4"></a>    <span style="color: #959077"># Attestations must be from the current or previous epoch</span>
<a id="__codelineno-33-5" name="__codelineno-33-5"></a>    <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_store_epoch(store)</span>
<a id="__codelineno-33-6" name="__codelineno-33-6"></a>    <span style="color: #959077"># Use GENESIS_EPOCH for previous when genesis to avoid underflow</span>
<a id="__codelineno-33-7" name="__codelineno-33-7"></a>    <span style="color: #F8F8F2">previous_epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">-</span> <span style="color: #AE81FF">1</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">current_epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">GENESIS_EPOCH</span> <span style="color: #66D9EF">else</span> <span style="color: #F8F8F2">GENESIS_EPOCH</span>
<a id="__codelineno-33-8" name="__codelineno-33-8"></a>    <span style="color: #959077"># If attestation target is from a future epoch, delay consideration until the epoch arrives</span>
<a id="__codelineno-33-9" name="__codelineno-33-9"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">[current_epoch,</span> <span style="color: #F8F8F2">previous_epoch]</span>
</code></pre></div></td></tr></table></div>
<h5 id="validate_on_attestation"><code>validate_on_attestation</code><a class="headerlink" href="#validate_on_attestation" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-18">18</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-19">19</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-20">20</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-21">21</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-22">22</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-23">23</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-24">24</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-25">25</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-34-26">26</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-34-1" name="__codelineno-34-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">validate_on_attestation</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">attestation:</span> <span style="color: #F8F8F2">Attestation,</span> <span style="color: #F8F8F2">is_from_block:</span> <span style="color: #F8F8F2">bool)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-34-2" name="__codelineno-34-2"></a>    <span style="color: #F8F8F2">target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target</span>
<a id="__codelineno-34-3" name="__codelineno-34-3"></a>
<a id="__codelineno-34-4" name="__codelineno-34-4"></a>    <span style="color: #959077"># If the given attestation is not from a beacon block message, we have to check the target epoch scope.</span>
<a id="__codelineno-34-5" name="__codelineno-34-5"></a>    <span style="color: #66D9EF">if</span> <span style="color: #FF4689">not</span> <span style="color: #F8F8F2">is_from_block:</span>
<a id="__codelineno-34-6" name="__codelineno-34-6"></a>        <span style="color: #F8F8F2">validate_target_epoch_against_current_time(store,</span> <span style="color: #F8F8F2">attestation)</span>
<a id="__codelineno-34-7" name="__codelineno-34-7"></a>
<a id="__codelineno-34-8" name="__codelineno-34-8"></a>    <span style="color: #959077"># Check that the epoch number and slot number are matching</span>
<a id="__codelineno-34-9" name="__codelineno-34-9"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">compute_epoch_at_slot(attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot)</span>
<a id="__codelineno-34-10" name="__codelineno-34-10"></a>
<a id="__codelineno-34-11" name="__codelineno-34-11"></a>    <span style="color: #959077"># Attestation target must be for a known block. If target block is unknown, delay consideration until block is found</span>
<a id="__codelineno-34-12" name="__codelineno-34-12"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks</span>
<a id="__codelineno-34-13" name="__codelineno-34-13"></a>
<a id="__codelineno-34-14" name="__codelineno-34-14"></a>    <span style="color: #959077"># Attestations must be for a known block. If block is unknown, delay consideration until the block is found</span>
<a id="__codelineno-34-15" name="__codelineno-34-15"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">beacon_block_root</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks</span>
<a id="__codelineno-34-16" name="__codelineno-34-16"></a>    <span style="color: #959077"># Attestations must not be for blocks in the future. If not, the attestation should not be considered</span>
<a id="__codelineno-34-17" name="__codelineno-34-17"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">beacon_block_root]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">&lt;=</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span>
<a id="__codelineno-34-18" name="__codelineno-34-18"></a>
<a id="__codelineno-34-19" name="__codelineno-34-19"></a>    <span style="color: #959077"># LMD vote must be consistent with FFG vote target</span>
<a id="__codelineno-34-20" name="__codelineno-34-20"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">get_checkpoint_block(</span>
<a id="__codelineno-34-21" name="__codelineno-34-21"></a>        <span style="color: #F8F8F2">store,</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">beacon_block_root,</span> <span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span>
<a id="__codelineno-34-22" name="__codelineno-34-22"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-34-23" name="__codelineno-34-23"></a>
<a id="__codelineno-34-24" name="__codelineno-34-24"></a>    <span style="color: #959077"># Attestations can only affect the fork choice of subsequent slots.</span>
<a id="__codelineno-34-25" name="__codelineno-34-25"></a>    <span style="color: #959077"># Delay consideration in the fork choice until their slot is in the past.</span>
<a id="__codelineno-34-26" name="__codelineno-34-26"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">get_current_slot(store)</span> <span style="color: #FF4689">&gt;=</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span>
</code></pre></div></td></tr></table></div>
<h5 id="store_target_checkpoint_state"><code>store_target_checkpoint_state</code><a class="headerlink" href="#store_target_checkpoint_state" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-6">6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-35-7">7</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-35-1" name="__codelineno-35-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">store_target_checkpoint_state</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">target:</span> <span style="color: #F8F8F2">Checkpoint)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-35-2" name="__codelineno-35-2"></a>    <span style="color: #959077"># Store target checkpoint state if not yet seen</span>
<a id="__codelineno-35-3" name="__codelineno-35-3"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">target</span> <span style="color: #FF4689">not</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states:</span>
<a id="__codelineno-35-4" name="__codelineno-35-4"></a>        <span style="color: #F8F8F2">base_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">copy(store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states[target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root])</span>
<a id="__codelineno-35-5" name="__codelineno-35-5"></a>        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">base_state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">compute_start_slot_at_epoch(target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch):</span>
<a id="__codelineno-35-6" name="__codelineno-35-6"></a>            <span style="color: #F8F8F2">process_slots(base_state,</span> <span style="color: #F8F8F2">compute_start_slot_at_epoch(target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch))</span>
<a id="__codelineno-35-7" name="__codelineno-35-7"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states[target]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">base_state</span>
</code></pre></div></td></tr></table></div>
<h5 id="update_latest_messages"><code>update_latest_messages</code><a class="headerlink" href="#update_latest_messages" title="Permanent link">&para;</a></h5>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-36-11">11</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-36-1" name="__codelineno-36-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">update_latest_messages</span><span style="color: #F8F8F2">(</span>
<a id="__codelineno-36-2" name="__codelineno-36-2"></a>    <span style="color: #F8F8F2">store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">attesting_indices:</span> <span style="color: #F8F8F2">Sequence[ValidatorIndex],</span> <span style="color: #F8F8F2">attestation:</span> <span style="color: #F8F8F2">Attestation</span>
<a id="__codelineno-36-3" name="__codelineno-36-3"></a><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-36-4" name="__codelineno-36-4"></a>    <span style="color: #F8F8F2">target</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target</span>
<a id="__codelineno-36-5" name="__codelineno-36-5"></a>    <span style="color: #F8F8F2">beacon_block_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">beacon_block_root</span>
<a id="__codelineno-36-6" name="__codelineno-36-6"></a>    <span style="color: #F8F8F2">non_equivocating_attesting_indices</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">[</span>
<a id="__codelineno-36-7" name="__codelineno-36-7"></a>        <span style="color: #F8F8F2">i</span> <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">attesting_indices</span> <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">not</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">equivocating_indices</span>
<a id="__codelineno-36-8" name="__codelineno-36-8"></a>    <span style="color: #F8F8F2">]</span>
<a id="__codelineno-36-9" name="__codelineno-36-9"></a>    <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">non_equivocating_attesting_indices:</span>
<a id="__codelineno-36-10" name="__codelineno-36-10"></a>        <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">i</span> <span style="color: #FF4689">not</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">latest_messages</span> <span style="color: #FF4689">or</span> <span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">latest_messages[i]</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch:</span>
<a id="__codelineno-36-11" name="__codelineno-36-11"></a>            <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">latest_messages[i]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">LatestMessage(epoch</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">target</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch,</span> <span style="color: #F8F8F2">root</span><span style="color: #FF4689">=</span><span style="color: #F8F8F2">beacon_block_root)</span>
</code></pre></div></td></tr></table></div>
<h3 id="handlers">Handlers<a class="headerlink" href="#handlers" title="Permanent link">&para;</a></h3>
<h4 id="on_tick"><code>on_tick</code><a class="headerlink" href="#on_tick" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-1">1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-2">2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-3">3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-4">4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-5">5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-6">6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-7">7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-37-8">8</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-37-1" name="__codelineno-37-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">on_tick</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">time:</span> <span style="color: #F8F8F2">uint64)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-37-2" name="__codelineno-37-2"></a>    <span style="color: #959077"># If the ``store.time`` falls behind, while loop catches up slot by slot</span>
<a id="__codelineno-37-3" name="__codelineno-37-3"></a>    <span style="color: #959077"># to ensure that every previous slot is processed with ``on_tick_per_slot``</span>
<a id="__codelineno-37-4" name="__codelineno-37-4"></a>    <span style="color: #F8F8F2">tick_slot</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">(time</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time)</span> <span style="color: #FF4689">//</span> <span style="color: #F8F8F2">SECONDS_PER_SLOT</span>
<a id="__codelineno-37-5" name="__codelineno-37-5"></a>    <span style="color: #66D9EF">while</span> <span style="color: #F8F8F2">get_current_slot(store)</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">tick_slot:</span>
<a id="__codelineno-37-6" name="__codelineno-37-6"></a>        <span style="color: #F8F8F2">previous_time</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time</span> <span style="color: #FF4689">+</span> <span style="color: #F8F8F2">(get_current_slot(store)</span> <span style="color: #FF4689">+</span> <span style="color: #AE81FF">1</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">*</span> <span style="color: #F8F8F2">SECONDS_PER_SLOT</span>
<a id="__codelineno-37-7" name="__codelineno-37-7"></a>        <span style="color: #F8F8F2">on_tick_per_slot(store,</span> <span style="color: #F8F8F2">previous_time)</span>
<a id="__codelineno-37-8" name="__codelineno-37-8"></a>    <span style="color: #F8F8F2">on_tick_per_slot(store,</span> <span style="color: #F8F8F2">time)</span>
</code></pre></div></td></tr></table></div>
<h4 id="on_block"><code>on_block</code><a class="headerlink" href="#on_block" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-18">18</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-19">19</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-20">20</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-21">21</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-22">22</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-23">23</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-24">24</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-25">25</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-26">26</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-27">27</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-28">28</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-29">29</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-30">30</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-31">31</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-32">32</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-33">33</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-34">34</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-35">35</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-36">36</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-37">37</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-38">38</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-39">39</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-40">40</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-41">41</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-42">42</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-43">43</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-44">44</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-45">45</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-46">46</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-47">47</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-38-48">48</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-38-1" name="__codelineno-38-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">on_block</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">signed_block:</span> <span style="color: #F8F8F2">SignedBeaconBlock)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-38-2" name="__codelineno-38-2"></a>    <span style="color: #F8F8F2">block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">signed_block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">message</span>
<a id="__codelineno-38-3" name="__codelineno-38-3"></a>    <span style="color: #959077"># Parent block must be known</span>
<a id="__codelineno-38-4" name="__codelineno-38-4"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states</span>
<a id="__codelineno-38-5" name="__codelineno-38-5"></a>    <span style="color: #959077"># Make a copy of the state to avoid mutability issues</span>
<a id="__codelineno-38-6" name="__codelineno-38-6"></a>    <span style="color: #F8F8F2">pre_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">copy(store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states[block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root])</span>
<a id="__codelineno-38-7" name="__codelineno-38-7"></a>    <span style="color: #959077"># Blocks cannot be in the future. If they are, their consideration must be delayed until they are in the past.</span>
<a id="__codelineno-38-8" name="__codelineno-38-8"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">get_current_slot(store)</span> <span style="color: #FF4689">&gt;=</span> <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span>
<a id="__codelineno-38-9" name="__codelineno-38-9"></a>
<a id="__codelineno-38-10" name="__codelineno-38-10"></a>    <span style="color: #959077"># Check that block is later than the finalized epoch slot (optimization to reduce calls to get_ancestor)</span>
<a id="__codelineno-38-11" name="__codelineno-38-11"></a>    <span style="color: #F8F8F2">finalized_slot</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">compute_start_slot_at_epoch(store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch)</span>
<a id="__codelineno-38-12" name="__codelineno-38-12"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">&gt;</span> <span style="color: #F8F8F2">finalized_slot</span>
<a id="__codelineno-38-13" name="__codelineno-38-13"></a>    <span style="color: #959077"># Check block is a descendant of the finalized block at the checkpoint finalized slot</span>
<a id="__codelineno-38-14" name="__codelineno-38-14"></a>    <span style="color: #F8F8F2">finalized_checkpoint_block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_checkpoint_block(</span>
<a id="__codelineno-38-15" name="__codelineno-38-15"></a>        <span style="color: #F8F8F2">store,</span>
<a id="__codelineno-38-16" name="__codelineno-38-16"></a>        <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">parent_root,</span>
<a id="__codelineno-38-17" name="__codelineno-38-17"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">epoch,</span>
<a id="__codelineno-38-18" name="__codelineno-38-18"></a>    <span style="color: #F8F8F2">)</span>
<a id="__codelineno-38-19" name="__codelineno-38-19"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">finalized_checkpoint_block</span>
<a id="__codelineno-38-20" name="__codelineno-38-20"></a>
<a id="__codelineno-38-21" name="__codelineno-38-21"></a>    <span style="color: #959077"># Check the block is valid and compute the post-state</span>
<a id="__codelineno-38-22" name="__codelineno-38-22"></a>    <span style="color: #F8F8F2">state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">pre_state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">copy()</span>
<a id="__codelineno-38-23" name="__codelineno-38-23"></a>    <span style="color: #F8F8F2">block_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">hash_tree_root(block)</span>
<a id="__codelineno-38-24" name="__codelineno-38-24"></a>    <span style="color: #F8F8F2">state_transition(state,</span> <span style="color: #F8F8F2">signed_block,</span> <span style="color: #66D9EF">True</span><span style="color: #F8F8F2">)</span>
<a id="__codelineno-38-25" name="__codelineno-38-25"></a>    <span style="color: #959077"># Add new block to the store</span>
<a id="__codelineno-38-26" name="__codelineno-38-26"></a>    <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">blocks[block_root]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">block</span>
<a id="__codelineno-38-27" name="__codelineno-38-27"></a>    <span style="color: #959077"># Add new state for this block to the store</span>
<a id="__codelineno-38-28" name="__codelineno-38-28"></a>    <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states[block_root]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">state</span>
<a id="__codelineno-38-29" name="__codelineno-38-29"></a>
<a id="__codelineno-38-30" name="__codelineno-38-30"></a>    <span style="color: #959077"># Add block timeliness to the store</span>
<a id="__codelineno-38-31" name="__codelineno-38-31"></a>    <span style="color: #F8F8F2">seconds_since_genesis</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">time</span> <span style="color: #FF4689">-</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">genesis_time</span>
<a id="__codelineno-38-32" name="__codelineno-38-32"></a>    <span style="color: #F8F8F2">time_into_slot_ms</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">seconds_to_milliseconds(seconds_since_genesis)</span> <span style="color: #FF4689">%</span> <span style="color: #F8F8F2">SLOT_DURATION_MS</span>
<a id="__codelineno-38-33" name="__codelineno-38-33"></a>    <span style="color: #F8F8F2">epoch</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_store_epoch(store)</span>
<a id="__codelineno-38-34" name="__codelineno-38-34"></a>    <span style="color: #F8F8F2">attestation_threshold_ms</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_attestation_due_ms(epoch)</span>
<a id="__codelineno-38-35" name="__codelineno-38-35"></a>    <span style="color: #F8F8F2">is_before_attesting_interval</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">time_into_slot_ms</span> <span style="color: #FF4689">&lt;</span> <span style="color: #F8F8F2">attestation_threshold_ms</span>
<a id="__codelineno-38-36" name="__codelineno-38-36"></a>    <span style="color: #F8F8F2">is_timely</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_current_slot(store)</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">block</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">slot</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">is_before_attesting_interval</span>
<a id="__codelineno-38-37" name="__codelineno-38-37"></a>    <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_timeliness[hash_tree_root(block)]</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">is_timely</span>
<a id="__codelineno-38-38" name="__codelineno-38-38"></a>
<a id="__codelineno-38-39" name="__codelineno-38-39"></a>    <span style="color: #959077"># Add proposer score boost if the block is timely and not conflicting with an existing block</span>
<a id="__codelineno-38-40" name="__codelineno-38-40"></a>    <span style="color: #F8F8F2">is_first_block</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">proposer_boost_root</span> <span style="color: #FF4689">==</span> <span style="color: #F8F8F2">Root()</span>
<a id="__codelineno-38-41" name="__codelineno-38-41"></a>    <span style="color: #66D9EF">if</span> <span style="color: #F8F8F2">is_timely</span> <span style="color: #FF4689">and</span> <span style="color: #F8F8F2">is_first_block:</span>
<a id="__codelineno-38-42" name="__codelineno-38-42"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">proposer_boost_root</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">hash_tree_root(block)</span>
<a id="__codelineno-38-43" name="__codelineno-38-43"></a>
<a id="__codelineno-38-44" name="__codelineno-38-44"></a>    <span style="color: #959077"># Update checkpoints in store if necessary</span>
<a id="__codelineno-38-45" name="__codelineno-38-45"></a>    <span style="color: #F8F8F2">update_checkpoints(store,</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">current_justified_checkpoint,</span> <span style="color: #F8F8F2">state</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">finalized_checkpoint)</span>
<a id="__codelineno-38-46" name="__codelineno-38-46"></a>
<a id="__codelineno-38-47" name="__codelineno-38-47"></a>    <span style="color: #959077"># Eagerly compute unrealized justification and finality</span>
<a id="__codelineno-38-48" name="__codelineno-38-48"></a>    <span style="color: #F8F8F2">compute_pulled_up_tip(store,</span> <span style="color: #F8F8F2">block_root)</span>
</code></pre></div></td></tr></table></div>
<h4 id="on_attestation"><code>on_attestation</code><a class="headerlink" href="#on_attestation" title="Permanent link">&para;</a></h4>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-15">15</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-16">16</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-17">17</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-39-18">18</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-39-1" name="__codelineno-39-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">on_attestation</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">attestation:</span> <span style="color: #F8F8F2">Attestation,</span> <span style="color: #F8F8F2">is_from_block:</span> <span style="color: #F8F8F2">bool</span> <span style="color: #FF4689">=</span> <span style="color: #66D9EF">False</span><span style="color: #F8F8F2">)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-39-2" name="__codelineno-39-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-39-3" name="__codelineno-39-3"></a><span style="color: #E6DB74">    Run ``on_attestation`` upon receiving a new ``attestation`` from either within a block or directly on the wire.</span>
<a id="__codelineno-39-4" name="__codelineno-39-4"></a>
<a id="__codelineno-39-5" name="__codelineno-39-5"></a><span style="color: #E6DB74">    An ``attestation`` that is asserted as invalid may be valid at a later time,</span>
<a id="__codelineno-39-6" name="__codelineno-39-6"></a><span style="color: #E6DB74">    consider scheduling it for later processing in such case.</span>
<a id="__codelineno-39-7" name="__codelineno-39-7"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-39-8" name="__codelineno-39-8"></a>    <span style="color: #F8F8F2">validate_on_attestation(store,</span> <span style="color: #F8F8F2">attestation,</span> <span style="color: #F8F8F2">is_from_block)</span>
<a id="__codelineno-39-9" name="__codelineno-39-9"></a>
<a id="__codelineno-39-10" name="__codelineno-39-10"></a>    <span style="color: #F8F8F2">store_target_checkpoint_state(store,</span> <span style="color: #F8F8F2">attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target)</span>
<a id="__codelineno-39-11" name="__codelineno-39-11"></a>
<a id="__codelineno-39-12" name="__codelineno-39-12"></a>    <span style="color: #959077"># Get state at the `target` to fully validate attestation</span>
<a id="__codelineno-39-13" name="__codelineno-39-13"></a>    <span style="color: #F8F8F2">target_state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">checkpoint_states[attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">target]</span>
<a id="__codelineno-39-14" name="__codelineno-39-14"></a>    <span style="color: #F8F8F2">indexed_attestation</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">get_indexed_attestation(target_state,</span> <span style="color: #F8F8F2">attestation)</span>
<a id="__codelineno-39-15" name="__codelineno-39-15"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">is_valid_indexed_attestation(target_state,</span> <span style="color: #F8F8F2">indexed_attestation)</span>
<a id="__codelineno-39-16" name="__codelineno-39-16"></a>
<a id="__codelineno-39-17" name="__codelineno-39-17"></a>    <span style="color: #959077"># Update latest messages for attesting indices</span>
<a id="__codelineno-39-18" name="__codelineno-39-18"></a>    <span style="color: #F8F8F2">update_latest_messages(store,</span> <span style="color: #F8F8F2">indexed_attestation</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">attesting_indices,</span> <span style="color: #F8F8F2">attestation)</span>
</code></pre></div></td></tr></table></div>
<h4 id="on_attester_slashing"><code>on_attester_slashing</code><a class="headerlink" href="#on_attester_slashing" title="Permanent link">&para;</a></h4>
<p><em>Note</em>: <code>on_attester_slashing</code> should be called while syncing and a client MUST
maintain the equivocation set of <code>AttesterSlashing</code>s from at least the latest
finalized checkpoint.</p>
<div class="highlight" style="background: #272822"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-1"> 1</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-2"> 2</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-3"> 3</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-4"> 4</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-5"> 5</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-6"> 6</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-7"> 7</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-8"> 8</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-9"> 9</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-10">10</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-11">11</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-12">12</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-13">13</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-14">14</a></span>
<span style="color: inherit; background-color: transparent; padding-left: 5px; padding-right: 5px;"><a href="#__codelineno-40-15">15</a></span></pre></div></td><td class="code"><div><pre style="line-height: 125%;"><span></span><code><a id="__codelineno-40-1" name="__codelineno-40-1"></a><span style="color: #66D9EF">def</span><span style="color: #F8F8F2"> </span><span style="color: #A6E22E">on_attester_slashing</span><span style="color: #F8F8F2">(store:</span> <span style="color: #F8F8F2">Store,</span> <span style="color: #F8F8F2">attester_slashing:</span> <span style="color: #F8F8F2">AttesterSlashing)</span> <span style="color: #FF4689">-&gt;</span> <span style="color: #66D9EF">None</span><span style="color: #F8F8F2">:</span>
<a id="__codelineno-40-2" name="__codelineno-40-2"></a><span style="color: #F8F8F2">    </span><span style="color: #E6DB74">&quot;&quot;&quot;</span>
<a id="__codelineno-40-3" name="__codelineno-40-3"></a><span style="color: #E6DB74">    Run ``on_attester_slashing`` immediately upon receiving a new ``AttesterSlashing``</span>
<a id="__codelineno-40-4" name="__codelineno-40-4"></a><span style="color: #E6DB74">    from either within a block or directly on the wire.</span>
<a id="__codelineno-40-5" name="__codelineno-40-5"></a><span style="color: #E6DB74">    &quot;&quot;&quot;</span>
<a id="__codelineno-40-6" name="__codelineno-40-6"></a>    <span style="color: #F8F8F2">attestation_1</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">attester_slashing</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">attestation_1</span>
<a id="__codelineno-40-7" name="__codelineno-40-7"></a>    <span style="color: #F8F8F2">attestation_2</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">attester_slashing</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">attestation_2</span>
<a id="__codelineno-40-8" name="__codelineno-40-8"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">is_slashable_attestation_data(attestation_1</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data,</span> <span style="color: #F8F8F2">attestation_2</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">data)</span>
<a id="__codelineno-40-9" name="__codelineno-40-9"></a>    <span style="color: #F8F8F2">state</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">block_states[store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">justified_checkpoint</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">root]</span>
<a id="__codelineno-40-10" name="__codelineno-40-10"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">is_valid_indexed_attestation(state,</span> <span style="color: #F8F8F2">attestation_1)</span>
<a id="__codelineno-40-11" name="__codelineno-40-11"></a>    <span style="color: #66D9EF">assert</span> <span style="color: #F8F8F2">is_valid_indexed_attestation(state,</span> <span style="color: #F8F8F2">attestation_2)</span>
<a id="__codelineno-40-12" name="__codelineno-40-12"></a>
<a id="__codelineno-40-13" name="__codelineno-40-13"></a>    <span style="color: #F8F8F2">indices</span> <span style="color: #FF4689">=</span> <span style="color: #F8F8F2">set(attestation_1</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">attesting_indices)</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">intersection(attestation_2</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">attesting_indices)</span>
<a id="__codelineno-40-14" name="__codelineno-40-14"></a>    <span style="color: #66D9EF">for</span> <span style="color: #F8F8F2">index</span> <span style="color: #FF4689">in</span> <span style="color: #F8F8F2">indices:</span>
<a id="__codelineno-40-15" name="__codelineno-40-15"></a>        <span style="color: #F8F8F2">store</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">equivocating_indices</span><span style="color: #FF4689">.</span><span style="color: #F8F8F2">add(index)</span>
</code></pre></div></td></tr></table></div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        
<div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/ethereum/consensus-specs" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../../..", "features": ["navigation.tabs", "search"], "search": "../../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../../assets/javascripts/bundle.f55a23d4.min.js"></script>
      
    
  </body>
</html>